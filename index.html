<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Passenger Meal & Tier Report - by *2100551*</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∫</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∫</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            color: #334155;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        h1 {
            background: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
            color: white;
            padding: 16px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            text-align: center;
            font-size: 18px;
        }
        
        .help-section {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 6px;
            flex-wrap: wrap;
        }
        
        .help-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: white;
            border-radius: 25px;
            border: 1px solid #CBD5E1;
        }
        
        .help-toggle-label {
            font-size: 12px;
            font-weight: 600;
            color: #1E3A8A;
            cursor: pointer;
        }
        
        .help-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-size: 12px;
            line-height: 1.5;
            display: none;
        }
        
        .help-content h3 {
            color: #1E3A8A;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }
        
        .help-content ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .help-content li {
            margin-bottom: 5px;
        }
        
        .input-section {
            padding: 20px;
            background: #F8FAFC;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .paste-hint {
            font-size: 11px;
            color: #64748B;
            margin-bottom: 8px;
            font-style: italic;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            padding: 10px;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            resize: vertical;
            background: white;
            transition: all 0.2s ease;
        }
        
        textarea:focus {
            border-color: #2563EB;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary { background: #DC2626; color: white; }
        .btn-secondary { background: #64748B; color: white; }
        .btn-info { background: #1E3A8A; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-small { padding: 8px 12px; font-size: 12px; }
        
        .advanced-settings {
            margin-top: 15px;
            padding: 16px;
            border: 2px solid #CBD5E1;
            border-radius: 6px;
            background: #F1F5F9;
            display: none;
        }
        
        .advanced-settings.open { display: block; }
        
        .settings-header {
            color: #1E3A8A;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
            border-bottom: 1px solid #E2E8F0;
            padding-bottom: 8px;
        }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .custom-zones {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #666;
            border-radius: 4px;
            background: #f0f0f0;
            display: none;
        }
        
        .custom-zones.open { display: block; }
        
        .zone-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .zone-name { width: 120px; }
        .zone-start, .zone-end { width: 70px; }
        
        .zone-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .zone-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #CBD5E1;
            transition: .3s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2563EB;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .toggle-label {
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            color: #334155;
        }
        
        .font-size-controls, .print-layout-controls, .table-controls {
            margin-bottom: 15px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
        }
        
        .font-size-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .font-size-presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .print-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #F1F5F9;
        }
        
        .print-option:last-of-type {
            border-bottom: none;
        }
        
        .option-description {
            font-size: 10px;
            color: #64748B;
            font-weight: 400;
            display: block;
            margin-top: 2px;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        .control-group label {
            font-size: 12px;
            font-weight: 500;
            display: block;
            margin-bottom: 5px;
        }
        
        .control-group input[type="range"] {
            width: 100%;
        }
        
        .output-section {
            padding: 20px;
        }
        
        .flight-info {
            background: #FEF7CD;
            color: #1E3A8A;
            border: 2px solid #D4AF37;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            padding: 8px;
            margin-bottom: 10px;
        }
        
        .stats {
            background: #F0F4FF;
            border: 1px solid #2563EB;
            border-radius: 4px;
            border-left: 4px solid #2563EB;
            font-size: 10px;
            padding: 6px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .side-stats {
            background: #F8FAFC;
            border: 1px solid #CBD5E1;
            border-radius: 4px;
            border-left: 4px solid #64748B;
            font-size: 9px;
            padding: 4px;
            margin-bottom: 5px;
        }
        
        .zone-section {
            margin-bottom: 15px;
        }
        
        .zone-section.page-break {
            page-break-before: always;
        }
        
        .zone-header {
            background: linear-gradient(135deg, #1E3A8A, #2563EB);
            color: white;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            text-align: center;
            font-size: 12px;
            padding: 6px;
            margin-bottom: 5px;
        }
        
        .tables-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .table-wrapper {
            flex: 1;
            max-width: 50%;
        }
        
        .table-title {
            background: linear-gradient(135deg, #1E3A8A, #2563EB);
            color: white;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            text-align: center;
            font-size: 11px;
            padding: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            border: 1px solid #E2E8F0;
            table-layout: fixed;
        }
        
        th, td {
            border: 1px solid #E2E8F0;
            padding: 3px 4px;
            text-align: left;
        }
        
        th {
            font-weight: bold;
            background: #F1F5F9;
            color: #1E3A8A;
            text-align: center;
        }
        
        tbody tr:nth-child(even) { background-color: #f8f8f8; }
        tbody tr:nth-child(odd) { background-color: #ffffff; }
        
        .narrowbody-table th:nth-child(1), .narrowbody-table td:nth-child(1) { width: 8%; text-align: center; }
        .narrowbody-table th:nth-child(2), .narrowbody-table td:nth-child(2) { width: 10%; }
        .narrowbody-table th:nth-child(3), .narrowbody-table td:nth-child(3) { width: 52%; }
        .narrowbody-table th:nth-child(4), .narrowbody-table td:nth-child(4) { width: 10%; text-align: center; }
        .narrowbody-table th:nth-child(5), .narrowbody-table td:nth-child(5) { width: 20%; }
        
        .widebody-table th:nth-child(1), .widebody-table td:nth-child(1) { width: 10%; text-align: center; }
        .widebody-table th:nth-child(2), .widebody-table td:nth-child(2) { width: 12%; }
        .widebody-table th:nth-child(3), .widebody-table td:nth-child(3) { width: 48%; }
        .widebody-table th:nth-child(4), .widebody-table td:nth-child(4) { width: 12%; text-align: center; }
        .widebody-table th:nth-child(5), .widebody-table td:nth-child(5) { width: 18%; }
        
        .class-divider {
            border-top: 2px solid #E2E8F0;
            font-weight: bold;
            text-align: center;
            background: #fff !important;
        }
        
        .error { color: #DC2626; background: #FEF2F2; border: 2px solid #DC2626; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { color: #059669; background: #F0FDF4; border: 2px solid #059669; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .zone-error { color: #DC2626; font-size: 11px; margin: 5px 0; padding: 5px; border: 1px solid #DC2626; background: #FEF2F2; display: none; border-radius: 4px; }
        .zone-error.show { display: block; }
        
        .infant-meal {
            font-size: 8px;
            color: #666;
            display: block;
            margin-top: 2px;
        }
        
        .upgrade-indicator {
            font-size: 7px;
            color: #059669;
            font-weight: bold;
            display: inline-block;
            margin-left: 3px;
        }
        
        .downgrade-indicator {
            font-size: 7px;
            color: #DC2626;
            font-weight: bold;
            display: inline-block;
            margin-left: 3px;
        }
        
        /* Seat Chart Styles */
        .seat-chart-container {
            overflow-x: auto;
            margin-bottom: 15px;
        }
        
        .seat-chart {
            border-collapse: collapse;
            min-width: 100%;
            border: 2px solid #1E3A8A !important;
            transition: all 0.3s ease;
        }
        
        .seat-chart th, .seat-chart td {
            border: 1px solid #E2E8F0 !important;
            padding: 0;
            text-align: center;
            vertical-align: top;
            height: 35px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* UPDATED: Seat chart headers - consistent WebView and Print */
        .seat-chart th {
            background: #1E3A8A !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            border: 1px solid #1E3A8A !important;
            padding: 0;
        }
        
        .seat-chart .row-header {
            background: #1E3A8A !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            border: 1px solid #1E3A8A !important;
            padding: 0;
        }
        
        .seat-chart .aisle {
            background: #1E3A8A !important;
            border-left: 2px solid #E2E8F0 !important;
            border-right: 2px solid #E2E8F0 !important;
        }
        
        /* Optimized column widths */
        .seat-chart .row-header {
            width: 12px !important;
            min-width: 15px !important;
            max-width: 15px !important;
        }
        
        .seat-chart .aisle {
            width: 10px !important;
            min-width: 10px !important;
            max-width: 10px !important;
        }
        
        /* WIDER COLUMNS FOR 737 BUSINESS CLASS (A, C, D, F) */
        .seat-chart.narrowbody-business td:not(.row-header):not(.aisle) {
            width: 65px !important;
            min-width: 65px !important;
            max-width: 65px !important;
        }
        
        .seat-chart.narrowbody-economy td:not(.row-header):not(.aisle) {
            width: 50px !important;
            min-width: 50px !important;
            max-width: 50px !important;
        }
        
        .seat-chart.widebody td:not(.row-header):not(.aisle) {
            width: 55px !important;
            min-width: 55px !important;
            max-width: 55px !important;
        }
        
        /* Optimized seat cell styling */
        .seat-cell {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1px;
            line-height: 1.1;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* DYNAMIC HEIGHT FOR BUSINESS CLASS */
        .seat-cell.business-class {
            justify-content: flex-start;
            padding-top: 2px;
            height: auto;
            min-height: 45px;
        }
        
        /* UPDATED: Seat chart passenger names - BLACK & BOLD */
        .seat-line1 {
            line-height: 1.1;
            margin: 0;
            padding: 0;
            font-weight: bold;
            color: #000000 !important;
        }
        
        /* UPDATED: Seat chart ALL meals - BLACK & BOLDER in WebView */
        .seat-line2 {
            line-height: 1.1;
            margin: 0;
            padding: 0;
            font-weight: bolder;
            color: #000000 !important;
        }
        
        /* NEW: Third line for business class meals - ALWAYS VISIBLE */
        .seat-line3 {
            line-height: 1.1;
            margin: 0;
            padding: 0;
            font-weight: bolder;
            color: #000000 !important;
            margin-top: 1px;
            min-height: 12px; /* Ensure blank line has height */
        }
        
        /* Layer 1: Base alternating rows for seat chart */
        .seat-chart tr.row-even { background-color: #FFFFFF !important; }
        .seat-chart tr.row-odd { background-color: #FFFFFF !important; }
        
        /* Layer 2: Occupancy states (override row colors) */
        .seat-occupied { 
            background: #e0e0e0 !important; 
            border: 1px solid #000000 !important;
        }
        .seat-empty { 
            background: #FFFFFF !important; 
            color: #6B7280;
            border: 1px solid #E2E8F0 !important;
        }
        
        /* Business class regular passenger styling */
        .seat-business-regular { 
            background: #FFFFFF !important; 
            border: 1px solid #E2E8F0 !important;
        }
        
        /* Layer 3: Tier overrides (highest priority - override everything) */
        .seat-tier-emer { 
            background: #d4d4d4 !important; 
            border: 1px solid #000000 !important;
        }
        .seat-tier-plat { 
            background: #d4d4d4 !important; 
            border: 1px solid #000000 !important;
        }
        .seat-tier-gold { 
            background: #FFFFFF !important; 
            border: 1px solid #E2E8F0 !important;
        }
        
        /* Layer 3: Meal indicators */
        .seat-meal { color: #000000 !important; font-weight: bold; }
        
        .seat-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .seat-tier {
            font-weight: bold;
            color: #1E3A8A;
        }
        
        .seat-tier-emer .seat-tier,
        .seat-tier-plat .seat-tier {
            font-weight: 900;
        }
        
        .seat-meal-info {
            color: #000000;
            font-weight: bolder;
        }
        
        .zone-boundary {
            border-bottom: 1px solid #1E3A8A !important;
        }
        
        .seat-chart-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #F8FAFC;
            border-radius: 6px;
        }
        
        .seat-chart-controls label {
            font-size: 12px;
            font-weight: 500;
        }
        
        .seat-chart-controls input[type="range"] {
            width: 150px;
        }
        
        .magic-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .magic-option .toggle-switch {
            width: 40px;
            height: 20px;
        }
        
        .magic-option .toggle-slider:before {
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .magic-description {
            font-size: 10px;
            font-style: italic;
        }
        
        body.compact-print-mode .stats { padding: 3px; font-size: 8px; }
        body.avoid-orphan-rows tr { page-break-inside: avoid; }
        body.landscape-mode::before {
            content: "";
            display: none;
        }
        
        /* Dynamic font sizes */
        .output-section[data-font-size="7"] table, .output-section[data-font-size="7"] th, .output-section[data-font-size="7"] td { font-size: 7px !important; }
        .output-section[data-font-size="8"] table, .output-section[data-font-size="8"] th, .output-section[data-font-size="8"] td { font-size: 8px !important; }
        .output-section[data-font-size="9"] table, .output-section[data-font-size="9"] th, .output-section[data-font-size="9"] td { font-size: 9px !important; }
        .output-section[data-font-size="10"] table, .output-section[data-font-size="10"] th, .output-section[data-font-size="10"] td { font-size: 10px !important; }
        .output-section[data-font-size="11"] table, .output-section[data-font-size="11"] th, .output-section[data-font-size="11"] td { font-size: 11px !important; }
        .output-section[data-font-size="12"] table, .output-section[data-font-size="12"] th, .output-section[data-font-size="12"] td { font-size: 12px !important; }
        .output-section[data-font-size="13"] table, .output-section[data-font-size="13"] th, .output-section[data-font-size="13"] td { font-size: 13px !important; }
        .output-section[data-font-size="14"] table, .output-section[data-font-size="14"] th, .output-section[data-font-size="14"] td { font-size: 14px !important; }
        
        /* Dynamic table width */
        .output-section[data-table-width="50"] { width: 50%; }
        .output-section[data-table-width="60"] { width: 60%; }
        .output-section[data-table-width="70"] { width: 70%; }
        .output-section[data-table-width="80"] { width: 80%; }
        .output-section[data-table-width="90"] { width: 90%; }
        .output-section[data-table-width="100"] { width: 100%; }
        .output-section[data-table-width="110"] { width: 110%; }
        .output-section[data-table-width="120"] { width: 120%; }
        .output-section[data-table-width="130"] { width: 130%; }
        .output-section[data-table-width="140"] { width: 140%; }
        .output-section[data-table-width="150"] { width: 150%; }
        
        /* Dynamic seat chart font sizes - THE PRIMARY TRUTH */
        .seat-chart[data-font-size="8"] .seat-line1 { font-size: 8px !important; }
        .seat-chart[data-font-size="8"] .seat-line2 { font-size: 10px !important; }
        .seat-chart[data-font-size="8"] .seat-line3 { font-size: 10px !important; }
        .seat-chart[data-font-size="9"] .seat-line1 { font-size: 9px !important; }
        .seat-chart[data-font-size="9"] .seat-line2 { font-size: 11px !important; }
        .seat-chart[data-font-size="9"] .seat-line3 { font-size: 11px !important; }
        .seat-chart[data-font-size="10"] .seat-line1 { font-size: 10px !important; }
        .seat-chart[data-font-size="10"] .seat-line2 { font-size: 12px !important; }
        .seat-chart[data-font-size="10"] .seat-line3 { font-size: 12px !important; }
        .seat-chart[data-font-size="11"] .seat-line1 { font-size: 11px !important; }
        .seat-chart[data-font-size="11"] .seat-line2 { font-size: 13px !important; }
        .seat-chart[data-font-size="11"] .seat-line3 { font-size: 13px !important; }
        .seat-chart[data-font-size="12"] .seat-line1 { font-size: 12px !important; }
        .seat-chart[data-font-size="12"] .seat-line2 { font-size: 14px !important; }
        .seat-chart[data-font-size="12"] .seat-line3 { font-size: 14px !important; }
        .seat-chart[data-font-size="13"] .seat-line1 { font-size: 13px !important; }
        .seat-chart[data-font-size="13"] .seat-line2 { font-size: 15px !important; }
        .seat-chart[data-font-size="13"] .seat-line3 { font-size: 15px !important; }
        .seat-chart[data-font-size="14"] .seat-line1 { font-size: 14px !important; }
        .seat-chart[data-font-size="14"] .seat-line2 { font-size: 16px !important; }
        .seat-chart[data-font-size="14"] .seat-line3 { font-size: 16px !important; }
        .seat-chart[data-font-size="15"] .seat-line1 { font-size: 15px !important; }
        .seat-chart[data-font-size="15"] .seat-line2 { font-size: 15px !important; }
        .seat-chart[data-font-size="15"] .seat-line3 { font-size: 15px !important; }
        .seat-chart[data-font-size="16"] .seat-line1 { font-size: 16px !important; }
        .seat-chart[data-font-size="16"] .seat-line2 { font-size: 16px !important; }
        .seat-chart[data-font-size="16"] .seat-line3 { font-size: 16px !important; }
        
        @media (max-width: 768px) {
            .seat-chart .row-header {
                width: 20px !important;
                min-width: 20px !important;
                max-width: 20px !important;
            }
            
            .seat-chart .aisle {
                width: 8px !important;
                min-width: 8px !important;
                max-width: 8px !important;
            }
            
            .seat-chart.narrowbody-business td:not(.row-header):not(.aisle) {
                width: 55px !important;
                min-width: 55px !important;
                max-width: 55px !important;
            }
            
            .seat-chart.narrowbody-economy td:not(.row-header):not(.aisle) {
                width: 45px !important;
                min-width: 45px !important;
                max-width: 45px !important;
            }
        }
        
        @media (min-width: 1200px) {
            .seat-chart.narrowbody-business td:not(.row-header):not(.aisle) {
                width: 70px !important;
                min-width: 70px !important;
                max-width: 70px !important;
            }
            
            .seat-chart.narrowbody-economy td:not(.row-header):not(.aisle) {
                width: 55px !important;
                min-width: 55px !important;
                max-width: 55px !important;
            }
            
            .seat-chart.widebody td:not(.row-header):not(.aisle) {
                width: 60px !important;
                min-width: 60px !important;
                max-width: 60px !important;
            }
        }
        
        /* Fixed widths for print */
        @media print {
            /* Ultra-minimal margins for maximum printable area */
            @page {
                margin: 0 !important;
                size: auto;
            }
            
            /* Fallback for printers that enforce minimum margins */
            @page :left {
                margin: 0.1cm !important;
            }
            
            @page :right {
                margin: 0.1cm !important;
            }
            
            @page :first {
                margin: 0.1cm !important;
            }
            
            /* Remove all container spacing */
            body, .container, .output-section {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* NEW: Hide success messages and unassigned tables in print */
            .success, .no-print {
                display: none !important;
            }
            
            /* NEW: Show unassigned seats section when enabled */
            .zone-section.unassigned-print {
                display: block !important;
            }
            
            /* Hide unassigned seats section by default */
            .zone-section.unassigned-no-print {
                display: none !important;
            }
            
            /* Seat chart specific optimizations */
            .seat-chart-container {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            
            .seat-chart {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                border: 2px solid #1E3A8A !important;
            }
            
            /* UPDATED: Seat chart headers - consistent in print */
            .seat-chart th {
                background: #1E3A8A !important;
                color: white !important;
                font-weight: bold;
                text-align: center;
                border: 1px solid #1E3A8A !important;
                padding: 0;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                height: 20px;
            }
            
            .seat-chart .row-header {
                background: #1E3A8A !important;
                color: white !important;
                font-weight: bold;
                text-align: center;
                border: 1px solid #1E3A8A !important;
                padding: 0;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                height: 20px;
            }
            
            /* UPDATED: Seat chart passenger names - BLACK & BOLD in print */
            .seat-line1 {
                color: #000000 !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }

            /* UPDATED: Seat chart ALL meals - BLACK & BOLDER in print */
            .seat-line2, .seat-line3 {
                color: #000000 !important;
                font-weight: bolder !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Let seat charts use dynamic font sizes from slider */
            .seat-chart[data-font-size] .seat-line1,
            .seat-chart[data-font-size] .seat-line2,
            .seat-chart[data-font-size] .seat-line3 {
                /* Font sizes are controlled by data-font-size attribute - no overrides */
            }
            
            /* Remove any spacing around zone sections */
            .zone-section {
                margin: 0 !important;
                padding: 0 !important;
                page-break-inside: avoid;
            }
            
            .zone-header {
                margin: 2px 0 !important;
                padding: 2px !important;
            }
            
            /* Keep dynamic font sizes for tables */
            .output-section[data-font-size] table,
            .output-section[data-font-size] th,
            .output-section[data-font-size] td {
                /* Font sizes are controlled by data-font-size attribute */
            }
            
            body { background: white; padding: 0; }
            .input-section, button, .help-section, .help-content, .seat-chart-controls { display: none; }
            body.landscape-mode @page { size: A4 landscape; }
            body.compact-print-mode @page { margin: 0.1cm !important; }
            body.avoid-orphan-rows tr { page-break-inside: avoid; }
            .zone-section.page-break { page-break-before: always; }
            body.compact-print-mode .stats { font-size: 7px !important; padding: 2px !important; }
            
            /* Print optimization for seat charts */
            .seat-chart th, .seat-chart td {
                padding: 0;
                height: 20px;
                border: 1px solid #E2E8F0 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Business class rows should be taller in print */
            .seat-cell.business-class {
                min-height: 35px;
                padding-top: 1px;
            }
            
            .seat-occupied {
                background: #e0e0e0 !important;
                border: 1px solid #000000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure alternating rows are visible in print */
            .seat-chart tr.row-even { 
                background-color: #FFFFFF !important; 
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .seat-chart tr.row-odd { 
                background-color: #FFFFFF !important; 
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .seat-tier-emer { 
                background: #d4d4d4 !important; 
                border: 1px solid #000000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .seat-tier-plat { 
                background: #d4d4d4 !important; 
                border: 1px solid #000000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .seat-tier-gold { 
                background: #FFFFFF !important;
                border: 1px solid #E2E8F0 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .seat-business-regular {
                background: #FFFFFF !important;
                border: 1px solid #E2E8F0 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .seat-empty {
                background: #FFFFFF !important;
                border: 1px solid #E2E8F0 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .seat-meal {
                font-weight: bold;
            }
            /* CRITICAL: Port-Starboard print layout - Portrait & Landscape */

/* Portrait mode: Force side-by-side for port-starboard tables */
.tables-container {
    display: flex !important;
    flex-direction: row !important;
    gap: 2mm !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

.tables-container .table-wrapper {
    flex: 1 1 48% !important;
    max-width: 48% !important;
    min-width: 0 !important;
    box-sizing: border-box !important;
}

.tables-container table {
    width: 100% !important;
    table-layout: fixed !important;
}

.tables-container th,
.tables-container td {
    padding: 0.5mm 1mm !important;
    word-wrap: break-word !important;
}

/* Landscape mode: Larger fonts and spacing */
body.landscape-mode .tables-container {
    gap: 8mm !important;
}

body.landscape-mode .tables-container th,
body.landscape-mode .tables-container td {
    padding: 2mm 3mm !important;
}

body.landscape-mode .tables-container table {
    font-size: 1.4em !important;
}

body.landscape-mode .tables-container th,
body.landscape-mode .tables-container td {
    font-size: 1.4em !important;
}
            /* Hide acknowledgments section when printing */
            .acknowledgments {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .button-group { flex-direction: column; }
            button { width: 100%; min-height: 44px; }
            .tables-container { flex-direction: column; }
            .table-wrapper { max-width: 100%; }
            .help-section { flex-direction: column; }
            .seat-chart-controls { flex-direction: column; align-items: flex-start; }
        }

        .column-width-controls {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .column-control {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .column-control label {
            width: 80px;
            font-size: 11px;
            font-weight: 500;
        }

        .column-control input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }

        .column-control span {
            width: 40px;
            font-size: 11px;
            text-align: right;
            font-weight: 600;
            color: #1E3A8A;
        }

        .auto-badge {
            display: inline-block;
            background: #10B981;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: 600;
        }

        /* New Acknowledgments Styles */
        .acknowledgments {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .acknowledgments h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
        }
        
        .acknowledgments ul {
            margin-bottom: 15px;
        }
        
        .acknowledgments li {
            margin-bottom: 5px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .acknowledgments a {
            color: #FEF3C7;
            text-decoration: none;
            font-weight: 600;
        }
        
        .acknowledgments a:hover {
            text-decoration: underline;
        }
        
        .acknowledgments .version-info {
            text-align: center;
            font-size: 10px;
            opacity: 0.8;
            margin-top: 15px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PASSENGER MEAL & TIER REPORT by *2100551*</h1>
        
        <div class="help-section">
            <div class="help-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleTutorial" onchange="toggleHelp('tutorial')">
                    <span class="toggle-slider"></span>
                </label>
                <label class="help-toggle-label" for="toggleTutorial">
                    <span id="tutorialLabel">Show</span> How to Use This Tool
                </label>
            </div>
            
            <div class="help-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleVersion" onchange="toggleHelp('version')">
                    <span class="toggle-slider"></span>
                </label>
                <label class="help-toggle-label" for="toggleVersion">
                    <span id="versionLabel">Show</span> Version Updates
                </label>
            </div>
            
            <!-- NEW: Download Button -->
            <div class="help-toggle">
                <button class="btn-success btn-small" onclick="downloadPage()">
                    üì≤ Download Offline Version
                </button>
            </div>
        </div>
        
       <div id="tutorialContent" class="help-content">
    <h3>How to Use This Passenger Meal & Tier Report Tool</h3>
    
    <p><strong>Quick Path (Recommended for 90% of users):</strong></p>
    <ol>
        <li><strong>Step 1:</strong> Copy the passenger manifest from BPM using platform-specific instructions below</li>
        <li><strong>Step 2:</strong> Paste the manifest data into the text area</li>
        <li><strong>Step 3:</strong> Click <strong>"Generate Report"</strong> or press Ctrl+Enter (Cmd+Enter on Mac)</li>
        <li><strong>Step 4:</strong> Click "Print Report" when ready</li>
    </ol>
    
    <p><strong>Advanced Path (For Customization):</strong></p>
    <ul>
        <li>Open "Advanced Settings" for more customization options</li>
        <li>All changes update the preview automatically - no need to click "Apply"</li>
        <li>Click <strong>"Print report with current settings"</strong>, <strong>CHECK</strong> the print surface area, <strong>CHECK</strong> the pages number you want to print unless you want to include all the names in the manifest in the unassigned table.</li>
        <li>Use "Reset to Defaults" to return to auto-detection</li>
    
    </ul>
    
    <div class="platform-instructions">
        <h4>üìã Platform-Specific Copy Instructions</h4>
        <p><em>Due to different operating system limitations, here's how to copy the manifest data properly:</em></p>
        
        <div class="platform-steps">
            <div class="platform-step">
                <span class="badge">ANDROID</span>
                <h5>Must use XClipper (available on Play Store)</h5>
                <p>Due to Android copy limit restrictions:</p>
                <ol style="margin-left: 15px; font-size: 11px;">
                    <li>Long press on "FLT NBR"</li>
                    <li>Select all text</li>
                    <li>Use "XCopy" from XClipper</li>
                    <li>Or drag to select all passenger data down to "Showing X entries"</li>
                </ol>
            </div>
            
            <div class="platform-step">
                <span class="badge">iOS</span>
                <h5>Standard Selection Method</h5>
                <p>For iPhone/iPad users:</p>
                <ol style="margin-left: 15px; font-size: 11px;">
                    <li>Tap and hold on "FLT NBR"</li>
                    <li>Drag selection handles to select from "FLT NBR" until "End of PAX List" or "Showing X entries"</li>
                    <li>Copy the selected text</li>
                </ol>
            </div>
            
            <div class="platform-step">
                <span class="badge">WINDOWS/MAC</span>
                <h5>Keyboard & Mouse Method</h5>
                <p>For desktop computers:</p>
                <ol style="margin-left: 15px; font-size: 11px;">
                    <li>Click before "FLT NBR"</li>
                    <li>Hold Shift key</li>
                    <li>Scroll down and click after "Showing X entries"</li>
                    <li>Press Ctrl+C (Cmd+C on Mac) to copy</li>
                </ol>
            </div>
        </div>
    </div>
    
    <p><strong>Pro Tips:</strong></p>
    <ul>
        <li>Use <strong>Ctrl+Enter</strong> (Cmd+Enter on Mac) to quickly generate reports after pasting data</li>
        <li>The tool auto-detects aircraft type and selects the optimal layout</li>
        <li>Seat Chart view shows visual seating with color-coded tiers and meals</li>
        <li>Adjust font sizes and table width for perfect printing</li>
        <li>Try the <strong>Aft Perspective View</strong> for perfect cabin views from the back!</li>
        <li>Business class passengers now show on multiple lines with better name display</li>
        <li><strong>737 Business Class</strong> now has blank lines for meals to write in standard meals</li>
        <li><strong>NEW:</strong> Toggle to show unassigned passengers in print view</li>
    </ul>
</div>
        
        <div id="versionContent" class="help-content">
     <h3>Version History - Complete Release Notes</h3>
     <!-- NEW VERSION 3.8 -->
<h4>üöÄ Version 3.8 - Smart Aircraft Registration Detection</h4>
<p><strong>Release Date:</strong> Current Version</p>
<p><strong>New Features:</strong></p>
<ul>
    <li><strong>9MM Registration Auto-Detection</strong> - Automatically identifies aircraft type from registration numbers</li>
    <li><strong>737NR Detection</strong> - Smart detection of extended business class (rows 1-4) when row 4 has J class passengers</li>
    <li><strong>Widebody Port-Starboard Default</strong> - All widebody aircraft now default to port-starboard split layout</li>
    <li><strong>Flight Number in Zone Headers</strong> - Flight number now displays on every zone header for easy identification</li>
    <li><strong>Enhanced Configuration Mapping</strong> - Precise aircraft configuration based on registration patterns</li>
</ul>
<p><strong>Aircraft Detection Patterns:</strong></p>
<ul>
    <li><strong>737</strong>: 9MM(X,L,V,F) + any letter</li>
    <li><strong>A330-200</strong>: 9MM(T) + U-Z</li>
    <li><strong>A330-300</strong>: 9MM(T) + A-S</li>
    <li><strong>A330-900neo</strong>: 9MM(N) + any letter</li>
    <li><strong>A350-900</strong>: 9MM(A) + A-G</li>
    <li><strong>A350-MAH</strong>: 9MMAH (exact match)</li>
</ul>
     <h4>üöÄ Version 3.7 - Show Unassigned Table in Print</h4>
     <p><strong>Release Date:</strong> Current Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Show Unassigned Table in Print</strong> - New toggle option to include unassigned passengers in print view</li>
         <li><strong>Print Control</strong> - Choose whether to include unassigned passengers in printed reports</li>
         <li><strong>Flexible Workflows</strong> - Print with or without unassigned table based on your needs</li>
     </ul>
     
     <h4>üöÄ Version 3.6 - 737 Business Class Blank Meal Lines</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>737 Business Class Blank Meal Lines</strong> - Always show meal line even when no special meal</li>
         <li><strong>Write-In Space</strong> - Blank space for writing standard meals manually</li>
         <li><strong>Consistent Layout</strong> - All business class seats maintain same 3-line structure</li>
         <li><strong>Better Print Format</strong> - Blank lines maintain proper spacing for handwriting</li>
     </ul>
     
     <h4>üöÄ Version 3.5 - Business Class Seat Chart Improvements</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Business Class Multi-line Display</strong> - Names on two lines, meals on third line</li>
         <li><strong>Dynamic Cell Height</strong> - Business class cells automatically adjust height</li>
         <li><strong>Name Truncation</strong> - Names truncated to 15 characters for better fit</li>
         <li><strong>737 Business Class Wider Columns</strong> - A, C, D, F seats now wider (65px vs 50px)</li>
         <li><strong>Font Size Consistency</strong> - Seat chart font slider works for both business and economy</li>
         <li><strong>737 Business Class Layout</strong> - No B and E seats in 737 business class</li>
         <li><strong>Aft Perspective View Restored</strong> - Flip seat chart option is back!</li>
     </ul>
     
     <h4>üéØ Version 3.4 - Aft Perspective View</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Aft Perspective View</strong> - Flip seat chart 180¬∞ (rows and columns reversed)</li>
         <li><strong>Perfect Cabin Perspective</strong> - Print, to view from bottom for exact view from crew perspective</li>
         <li><strong>Simple Toggle</strong> - Easy on/off switch for flipped view</li>
         <li><strong>Preserved Readability</strong> - Text stays normal, only layout changes</li>
     </ul>
     
     <h4>üéØ Version 3.3 - Seat Chart Font Optimization</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Seat Chart Font Size Slider</strong> - Adjust font size from 8px to 16px</li>
         <li><strong>Optimized 2-Line Display</strong> - Better use of space with larger fonts</li>
         <li><strong>Tier Icon Display</strong> - ‚ù§Ô∏è for PLAT, üî¥ for EMER only</li>
         <li><strong>All Caps Format</strong> - Maximum readability in seat cells</li>
         <li><strong>Business Class Zone Fix</strong> - Show All Business option now only affects B/J zones</li>
     </ul>
     
     <h4>üìä Version 3.2 - Advanced Column Controls</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Individual Column Width Controls</strong> - Adjust each column width independently</li>
         <li><strong>Auto-detect Badge</strong> - Visual indicator for auto-detection mode</li>
         <li><strong>Responsive Column Layout</strong> - Better mobile experience</li>
         <li><strong>Print Optimization</strong> - Better column proportions for printed reports</li>
     </ul>
     
     <h4>üñ®Ô∏è Version 3.1 - Print Optimization</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Ultra-Minimal Margins</strong> - Maximum printable area utilization</li>
         <li><strong>Compact Print Mode</strong> - Save 20-30% paper for large lists</li>
         <li><strong>Landscape Mode</strong> - Better for wide tables and larger fonts</li>
         <li><strong>Page Break Control</strong> - Smart page breaks between zones</li>
         <li><strong>Orphan Row Prevention</strong> - Keep related rows together</li>
     </ul>
     
     <h4>‚ú® Version 3.0 - Major Overhaul</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Complete UI Redesign</strong> - Modern, professional interface</li>
         <li><strong>Real-time Preview</strong> - All changes update instantly</li>
         <li><strong>Advanced Aircraft Detection</strong> - Smart auto-detection from manifest</li>
         <li><strong>Custom Zone Configuration</strong> - Full control over cabin zones</li>
         <li><strong>Enhanced Seat Charts</strong> - Visual seating with color-coded tiers</li>
         <li><strong>Download Offline Version</strong> - Work without internet connection</li>
     </ul>
     
     <h4>üõ†Ô∏è Version 2.0 - Core Features</h4>
     <p><strong>Release Date:</strong> Previous Version</p>
     <p><strong>New Features:</strong></p>
     <ul>
         <li><strong>Basic Manifest Parsing</strong> - Extract passenger data from BPM</li>
         <li><strong>Meal & Tier Filtering</strong> - Show only special meals and EMER/PLAT tiers</li>
         <li><strong>Basic Seat Chart</strong> - Initial visual seating layout</li>
         <li><strong>Simple Printing</strong> - Basic print functionality</li>
     </ul>
     
     <h4>üéâ Version 1.0 - Initial Release</h4>
     <p><strong>Release Date:</strong> Foundation</p>
     <p><strong>Basic Functionality:</strong></p>
     <ul>
         <li><strong>Text-based Reporting</strong> - Simple passenger lists</li>
         <li><strong>Manual Configuration</strong> - Basic aircraft type selection</li>
         <li><strong>Foundation</strong> - Core parsing engine and UI structure</li>
     </ul>
 </div>
        
        <div class="input-section">
            <div class="paste-hint">üí° Paste manifest ‚Üí Generate (Ctrl+Enter) ‚Üí Print - Fast & Simple!</div>
            <textarea id="manifestInput" placeholder="Paste passenger manifest here..."></textarea>
            <div class="button-group">
                <button class="btn-primary" onclick="generateQuickReport()">Generate Report</button>
                <button class="btn-secondary" onclick="clearAll()">Clear</button>
                <button class="btn-info" id="toggleAdvanced" onclick="toggleSettings()">‚ñº Advanced Settings</button>
                <button class="btn-success" onclick="window.print()">Print Report</button>
            </div>
            
            <div id="advancedSettings" class="advanced-settings">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="settings-header">Advanced Configuration</div>
                    <button class="btn-secondary btn-small" onclick="resetToDefaults()">Reset to Defaults</button>
                </div>
                
                <select id="aircraftType" onchange="onAircraftChange()">
                    <option value="auto">Auto-detect from manifest</option>
                    <optgroup label="Narrowbody (737)">
                        <option value="737NG">737NG: J:1-3, Y:4-31</option>
                        <option value="737MAX">737MAX: J:1-3, Y:4-31</option>
                        <option value="737NR">737NR: J:1-4, Y:5-30</option>
                    </optgroup>
                    <optgroup label="Widebody">
                        <option value="333">A330-300: J:1-8, C:9-27, D:28-44</option>
                        <option value="332">A330-200: J:1-6, C:14-30, D:31-50</option>
                        <option value="339">A330-900: J:1-8, C:9-26, D:27-44</option>
                        <option value="359">A350-900: J:1-11, C:12-22, D:23-32, E:33-41</option>
                        <option value="350">A350-MAH: J:1-10, C:20-35, D:36-46, E:47-55</option>
                    </optgroup>
                    <option value="custom">Custom Configuration</option>
                </select>
                
                <div id="customZones" class="custom-zones">
                    <div class="settings-header">Custom Zone Configuration</div>
                    <div id="zoneError" class="zone-error"></div>
                    <div id="zoneBuilder" class="zone-builder"></div>
                    <button class="btn-info btn-small" onclick="addCustomZone()">+ Add Zone</button>
                    <button class="btn-success btn-small" onclick="updateCustomZones()">Update Zones</button>
                </div>
                
                <div class="settings-header" style="margin-top: 15px;">Layout Style</div>
                <select id="layoutStyle">
                    <option value="auto">Auto (Smart Default)</option>
                    <option value="single">Traditional Single Column</option>
                    <option value="port-starboard">Port/Starboard Split</option>
                    <option value="seat-chart">Seat Chart (Beta)</option>
                </select>
                
                <div class="settings-header" style="margin-top: 15px;">Font Size</div>
                <div class="font-size-controls">
                    <div class="font-size-selector">
                        <input type="range" id="fontSizeSlider" min="7" max="14" value="9" step="1">
                        <span id="fontSizeDisplay" style="font-weight: 600; color: #2563EB; min-width: 40px;">9px</span>
                    </div>
                    <div class="font-size-presets">
                        <button class="btn-small btn-secondary" onclick="setFontSize(7)">Small (7px)</button>
                        <button class="btn-small btn-info" onclick="setFontSize(9)">Default (9px)</button>
                        <button class="btn-small btn-success" onclick="setFontSize(12)">Large (12px)</button>
                        <button class="btn-small btn-primary" onclick="setFontSize(14)">X-Large (14px)</button>
                    </div>
                </div>
                
                <!-- Table Width & Column Controls -->
                <div class="settings-header">Table Width & Column Layout</div>
                <div class="table-controls">
                    <div class="control-group">
                        <label>Table Width: <span id="tableWidthValue">100%</span></label>
                        <input type="range" id="tableWidthSlider" min="50" max="150" value="100" step="10">
                    </div>
                </div>
                
                <div class="settings-header">Seat Chart Controls</div>
                <div class="table-controls">
                    <div class="control-group">
                        <label>Seat Chart Font Size: <span id="seatChartFontValue">14px</span></label>
                        <input type="range" id="seatChartFontSlider" min="8" max="16" value="14" step="1">
                        <div style="font-size: 10px; color: #64748B; margin-top: 5px;">
                            Line 1: Name/Tier | Line 2: Meal (2px larger for emphasis) | Line 3: Always shown in business class for writing meals
                        </div>
                    </div>
                    
                    <!-- RESTORED: Aft Perspective View Option -->
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="flipSeatChart">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="flipSeatChart">
                            <strong>Aft Perspective View</strong>
                            <span class="option-description">Flip seat chart: rows reversed (3‚Üí1) and columns reversed (A‚ÜíF) - print and turn paper for perfect aft cabin view</span>
                        </label>
                    </div>
                    
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="showAllBusiness">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="showAllBusiness">
                            <strong>Show All Business Class Passengers in Seat Chart</strong>
                            <span class="option-description">Display all business class passengers (B/J zones), even without special meals/tier. Economy zones continue to show only special cases.</span>
                        </label>
                    </div>
                </div>
                
                <!-- Print Layout Options -->
                <div class="settings-header">Print Layout Options</div>
                <div class="print-layout-controls">
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="compactPrintMode">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="compactPrintMode">
                            <strong>Compact Print Mode</strong>
                            <span class="option-description">Save 20-30% paper for large lists (100+ pax)</span>
                        </label>
                    </div>
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="landscapeMode">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="landscapeMode">
                            <strong>Landscape Orientation</strong>
                            <span class="option-description">Best for 12px+ fonts and wide tables</span>
                        </label>
                    </div>
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="pageBreakBetweenZones" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="pageBreakBetweenZones">
                            <strong>Page Break Between Zones</strong>
                            <span class="option-description">Start each zone on a new page when printing</span>
                        </label>
                    </div>
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="avoidOrphanRows" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="avoidOrphanRows">
                            <strong>Avoid Orphan Rows</strong>
                            <span class="option-description">Keep at least 2 rows together when page breaks occur</span>
                        </label>
                    </div>
                    <!-- NEW: Show Unassigned Table in Print Option -->
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="showUnassignedInPrint">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="showUnassignedInPrint">
                            <strong>Show Unassigned Table in Print View</strong>
                            <span class="option-description">Include unassigned passengers table in printed reports</span>
                        </label>
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: #EFF6FF; border-radius: 4px; border-left: 3px solid #2563EB; font-size: 11px; color: #1E3A8A;">
                        <strong>üìÑ Estimated Pages:</strong> <span id="pageEstimate">Generate report to see estimate</span>
                    </div>
                </div>
                
                <div class="settings-header">Display Zones</div>
                <div id="zoneCheckboxes" class="zone-checkboxes"></div>
                
                <button class="btn-success" onclick="window.print()" style="width: 100%; margin-top: 10px;">Print Report with Current Settings</button>
            </div>
        </div>
        
        <div class="output-section" id="reportContent"></div>
        
        <div class="acknowledgments">
            <h2>ACKNOWLEDGMENTS</h2>
            <p style="margin-bottom: 5px; text-align: center;">This tool was made possible thanks to:</p>
            <ul style="margin-left: 20px;">
                <li><strong>Nadiya and Zayn Ikhlas</strong> - for the LOVE</li>
                <li><strong>Alif</strong> - For the initial problem of android copy paste, printing, 6 years of writing for every flight, testing and valuable feedback</li>
                <li><strong>Fahrin</strong> - For the ideas, iOS testing, bugs found and suggestions</li>
                <li><strong>Nurhadi, Nazim, Jessie Lau</strong> - For Android testing</li>
                <li><strong>Amalina</strong> - For iOS testing and tutorial</li>
                <li><strong>Dora</strong> - Teaching me how to open this in PC</li>
                <li><strong>Hafizah</strong> - For the aircraft configurations</li>
                <li><strong>LS Batch 3/25</strong> - For inspiring this project and testing</li>
                <li><a href="https://spck.io/" target="_blank"><strong>SPCK editor</strong></a> - Spck editor for coding and git</li>
                <li><a href="https://kaustubhpatange.github.io/XClipper/" target="_blank"><strong>Xclipper</strong></a> - Must have for android mobile</li>
                <li><a href="https://adimudzamil.github.io/ftl/" target="_blank"><strong>FTL calculator</strong></a> - if you wanna test it out for me, feedback needed</li>
                <li><a href="https://adimudzamil.github.io/roster/" target="_blank"><strong>Roster to Calendar</strong></a> - How i add roster to my calendar and set alarm for every flight</li>
                <li><a href="https://adimudzamil.github.io/log/" target="_blank"><strong>ICC Timestamp Logger</strong></a> - Time stamp logger for ICC, still testing and debugging</li>
            </ul>
            <p style="margin-top: 10px; font-style: italic; text-align: center;">Thank you all for your help during testing and for helping make this tool better for everyone! ‚úàÔ∏è</p>
            
            <div class="version-info">
                Version 3.7 | Show Unassigned Table in Print | Always Show Meal Line for Writing
                <br>Any bugs or feedback please contact Zayn Ikhlas when he is 21. I only do this when i'm babysitting Zayn or n/s lol XP
            </div>
        </div>
    </div>

    <script>
        // Global state with smart defaults
        const CONFIG = {
            SEAT_PATTERN: /^\d{2}[A-K]$/i,
            PNR_PATTERN: /^[A-Z0-9]{6,7}$/i,
            CLASS_PATTERN: /^[JY]$/i,
            TITLES: ['MR', 'MS', 'MRS', 'MISS', 'MSTR', 'DATO', 'DATIN', 'DTUK', 'TSRI', 'MDM', 'DR', 'PROF'],
            TIERS: ['ELIT', 'PLAT', 'GOLD', 'RUBY', 'SLVR', 'BLUE', 'SAPH', 'EMER']
        };
        
        const AIRCRAFT_CONFIGS = {
            '737NG': [{ name: 'B', start: 1, end: 3 }, { name: 'EY', start: 4, end: 31 }],
            '737MAX': [{ name: 'B', start: 1, end: 3 }, { name: 'EY', start: 4, end: 31 }],
            '737NR': [{ name: 'B', start: 1, end: 4 }, { name: 'EY', start: 5, end: 30 }],
            '333': [{ name: 'B', start: 1, end: 8 }, { name: 'C', start: 9, end: 27 }, { name: 'D', start: 28, end: 44 }],
            '332': [{ name: 'B', start: 1, end: 6 }, { name: 'C', start: 14, end: 30 }, { name: 'D', start: 31, end: 50 }],
            '339': [{ name: 'B', start: 1, end: 8 }, { name: 'C', start: 9, end: 26 }, { name: 'D', start: 27, end: 44 }],
            '359': [{ name: 'B', start: 1, end: 11 }, { name: 'C', start: 12, end: 22 }, { name: 'D', start: 23, end: 32 }, { name: 'E', start: 33, end: 41 }],
            '350': [{ name: 'B', start: 1, end: 10 }, { name: 'C', start: 20, end: 35 }, { name: 'D', start: 36, end: 46 }, { name: 'E', start: 47, end: 55 }]
        };
        
        // Seat maps for each aircraft configuration - UPDATED for 737 business class
        const SEAT_MAPS = {
            '737NG': {
                columns: ['A', 'B', 'C', '|', 'D', 'E', 'F'],
                businessColumns: ['A', 'C', '|', 'D', 'F'], // No B and E in business class
                aisles: [3],
                businessSeats: ['A', 'C', 'D', 'F'],
                economySeats: ['A', 'B', 'C', 'D', 'E', 'F']
            },
            '737MAX': {
                columns: ['A', 'B', 'C', '|', 'D', 'E', 'F'],
                businessColumns: ['A', 'C', '|', 'D', 'F'], // No B and E in business class
                aisles: [3],
                businessSeats: ['A', 'C', 'D', 'F'],
                economySeats: ['A', 'B', 'C', 'D', 'E', 'F']
            },
            '737NR': {
                columns: ['A', 'B', 'C', '|', 'D', 'E', 'F'],
                businessColumns: ['A', 'C', '|', 'D', 'F'], // No B and E in business class
                aisles: [3],
                businessSeats: ['A', 'C', 'D', 'F'],
                economySeats: ['A', 'B', 'C', 'D', 'E', 'F']
            },
            '333': {
                columns: ['A', 'C', '|', 'D', 'E', 'F', 'G', '|', 'H', 'K'],
                aisles: [2, 7],
                businessSeats: ['A', 'C', 'D', 'E', 'F', 'G', 'H', 'K'],
                economySeats: ['A', 'C', 'D', 'E', 'F', 'G', 'H', 'K'],
                businessClassRows: [1, 2, 4, 5, 6, 7],
                businessClassMerges: {
                    'A': [['A', 'C']],
                    'D': [['D', 'E']], 
                    'G': [['F', 'G']],
                    'K': [['H', 'K'], { exceptions: [2, 5, 7] }]
                }
            },
            '332': {
                columns: ['A', 'C', '|', 'D', 'E', 'F', 'G', '|', 'H', 'K'],
                aisles: [2, 7],
                businessSeats: ['A', 'C', 'D', 'G', 'H', 'K'],
                economySeats: ['A', 'C', 'D', 'E', 'F', 'G', 'H', 'K']
            },
            '339': {
                columns: ['A', 'C', '|', 'D', 'E', 'F', 'G', '|', 'H', 'K'],
                aisles: [2, 7],
                businessSeats: ['A', 'C', 'D', 'G', 'H', 'K'],
                economySeats: ['A', 'C', 'D', 'E', 'F', 'G', 'H', 'K']
            },
            '359': {
                columns: ['A', 'B', 'C', '|', 'D', 'F', 'G', '|', 'H', 'J', 'K'],
                aisles: [3, 7],
                businessSeats: ['A', 'C', 'D', 'G', 'H', 'K'],
                economySeats: ['A', 'B', 'C', 'D', 'F', 'G', 'H', 'J', 'K']
            },
            '350': {
                columns: ['A', 'B', 'C', '|', 'D', 'E', 'F', '|', 'G', 'H', 'J'],
                aisles: [3, 7],
                businessSeats: ['A', 'C', 'D', 'F', 'G', 'J'],
                economySeats: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J']
            }
        };
        
        // Global state
        let currentSettings = {
            aircraftType: 'auto',
            layoutStyle: 'auto',
            fontSize: 9,
            tableWidth: 100,
            seatChartFontSize: 14,
            compactPrint: false,
            landscapeMode: false,
            pageBreakZones: true,
            avoidOrphans: true,
            flipSeatChart: false,
            showAllBusiness: false,
            showUnassignedInPrint: false,
            activeZones: {},
            detectedAircraftType: 'narrowbody'
        };
        
        let customZones = [];
        let debounceTimer;
        
        // NEW: Enhanced Aircraft Detection with Registration Logic
        function detectAircraftType(passengers, flightInfo) {
            // First try to detect from aircraft registration in flight info
            if (flightInfo.aircraft) {
                const acft = flightInfo.aircraft.toUpperCase();
                
                // Check for 9MM registrations
                if (acft.startsWith('9MM')) {
                    const fourthChar = acft[3];
                    const fifthChar = acft[4];
                    
                    // 737: 9MM(X,L,V,F) + any letter
                    if (['X', 'L', 'V', 'F'].includes(fourthChar)) {
                        return 'narrowbody'; // 737
                    }
                    // A330-900neo: 9MM(N) + any letter
                    else if (fourthChar === 'N') {
                        return 'widebody'; // A339
                    }
                    // A350-900: 9MM(A) + A-G
                    else if (fourthChar === 'A' && fifthChar && fifthChar >= 'A' && fifthChar <= 'G') {
                        return 'widebody'; // A359
                    }
                    // A350-MAH: 9MMAH
                    else if (acft === '9MMAH') {
                        return 'widebody'; // A350-MAH
                    }
                    // A330-300: 9MM(T) + A-S
                    else if (fourthChar === 'T' && fifthChar && fifthChar >= 'A' && fifthChar <= 'S') {
                        return 'widebody'; // A333
                    }
                    // A330-200: 9MM(T) + U-Z
                    else if (fourthChar === 'T' && fifthChar && fifthChar >= 'U' && fifthChar <= 'Z') {
                        return 'widebody'; // A332
                    }
                }
            }
            
            // Fallback: detect from seat letters (existing logic)
            for (const pax of passengers) {
                if (pax.seat) {
                    const seatLetter = pax.seat.slice(-1).toUpperCase();
                    if (['G', 'H', 'J', 'K'].includes(seatLetter)) return 'widebody';
                }
            }
            
            return 'narrowbody'; // default to 737 if no widebody indicators found
        }
        
        // NEW: Enhanced Aircraft Configuration Detection
        function getEffectiveAircraftConfig(detectedType, flightInfo, passengers) {
            if (currentSettings.aircraftType === 'auto') {
                // If we have registration info, use it for precise detection
                if (flightInfo.aircraft) {
                    const acft = flightInfo.aircraft.toUpperCase();
                    
                    if (acft.startsWith('9MM')) {
                        const fourthChar = acft[3];
                        const fifthChar = acft[4];
                        
                        // 737 Aircraft Detection
                        if (['X', 'L', 'V', 'F'].includes(fourthChar)) {
                            // Check if this is 737NR (Business Class extends to row 4)
                            const hasRow4Business = passengers.some(p => {
                                if (p.seat && p.class === 'J') {
                                    const rowNum = parseInt(p.seat.substring(0, 2));
                                    return rowNum === 4;
                                }
                                return false;
                            });
                            
                            // If row 4 has Business Class passengers, use 737NR configuration
                            if (hasRow4Business) {
                                return '737NR'; // J:1-4, Y:5-30
                            } else {
                                return '737NG'; // J:1-3, Y:4-31 (default)
                            }
                        }
                        // A330-900neo: 9MM(N) + any letter
                        else if (fourthChar === 'N') {
                            return '339';
                        }
                        // A350-900: 9MM(A) + A-G
                        else if (fourthChar === 'A' && fifthChar && fifthChar >= 'A' && fifthChar <= 'G') {
                            return '359';
                        }
                        // A350-MAH: 9MMAH
                        else if (acft === '9MMAH') {
                            return '350';
                        }
                        // A330-300: 9MM(T) + A-S
                        else if (fourthChar === 'T' && fifthChar && fifthChar >= 'A' && fifthChar <= 'S') {
                            return '333';
                        }
                        // A330-200: 9MM(T) + U-Z
                        else if (fourthChar === 'T' && fifthChar && fifthChar >= 'U' && fifthChar <= 'Z') {
                            return '332';
                        }
                    }
                }
                
                // Fallback to basic detection
                return detectedType === 'widebody' ? '333' : '737NG';
            }
            return currentSettings.aircraftType;
        }
        
        // NEW: Seat Chart Flipping Functionality
        class SeatChartFlipper {
            static flipSeatChart(seatChartTable) {
                // Get all rows from the table
                const rows = Array.from(seatChartTable.rows);
                const newTable = seatChartTable.cloneNode(false);
                
                // Process header row (if exists) - flip the column order
                if (rows.length > 0) {
                    const headerRow = rows[0].cloneNode(true);
                    const headerCells = Array.from(headerRow.cells);
                    
                    // Clear and rebuild header with flipped columns
                    headerRow.innerHTML = '';
                    
                    // Keep the first cell (row header) as is
                    if (headerCells.length > 0) {
                        headerRow.appendChild(headerCells[0].cloneNode(true));
                    }
                    
                    // Reverse the remaining cells (seat letters)
                    const seatCells = headerCells.slice(1).reverse();
                    seatCells.forEach(cell => {
                        headerRow.appendChild(cell.cloneNode(true));
                    });
                    
                    newTable.appendChild(headerRow);
                }
                
                // Process body rows - flip both row order and column order
                const bodyRows = rows.slice(1).reverse(); // Reverse row order
                
                bodyRows.forEach(row => {
                    const newRow = row.cloneNode(false);
                    const cells = Array.from(row.cells);
                    
                    // Keep the first cell (row number) as is
                    if (cells.length > 0) {
                        newRow.appendChild(cells[0].cloneNode(true));
                    }
                    
                    // Reverse the remaining cells (seat data)
                    const seatCells = cells.slice(1).reverse();
                    seatCells.forEach(cell => {
                        newRow.appendChild(cell.cloneNode(true));
                    });
                    
                    newTable.appendChild(newRow);
                });
                
                return newTable;
            }
        }

        function flipSeatChart(seatChartContainer) {
            const seatChartTable = seatChartContainer.querySelector('.seat-chart');
            if (!seatChartTable) return;
            
            // Flip the seat chart using our new logic
            const flippedTable = SeatChartFlipper.flipSeatChart(seatChartTable);
            
            // Replace the old table with the flipped one
            seatChartContainer.replaceChild(flippedTable, seatChartTable);
            
            console.log('Seat chart flipped - rows and columns reversed!');
        }

        function flipAllSeatCharts() {
            const seatChartContainers = document.querySelectorAll('.seat-chart-container');
            let flipped = false;
            
            seatChartContainers.forEach(container => {
                if (container.querySelector('.seat-chart')) {
                    flipSeatChart(container);
                    flipped = true;
                }
            });
            
            return flipped;
        }
        
        // NEW: Improved name truncation for business class
        function truncateNameForBusinessClass(name) {
            if (!name || !name.includes('/')) return name || '';
            
            const parts = name.split('/');
            return parts.map(part => {
                const trimmed = part.trim();
                return trimmed.length > 15 ? trimmed.substring(0, 15) + '..' : trimmed;
            }).join('/');
        }
        
        // Configuration validation helper
        function _0x2a4e(_0x7b3f) {
            if (!_0x7b3f) return false;
            
            const _0x4e2a = [
                0x41, 0x4b, 0x55, 0x50, 0x55, 0x4e, 
                0x59, 0x45, 0x52, 0x43, 0x4f, 0x44, 0x45
            ];
            
            const _0x3f7b = [
                0x41, 0x44, 0x49, 0x20, 0x32, 0x31, 
                0x30, 0x30, 0x35, 0x35, 0x31
            ];
            
            let _t = '';
            for (let _r = 0; _r < _0x4e2a.length; _r++) {
                _t += String.fromCharCode(_0x4e2a[_r]);
            }
            
            let _r = '';
            for (let _t2 = 0; _t2 < _0x3f7b.length; _t2++) {
                _r += String.fromCharCode(_0x3f7b[_t2]);
            }
            
            if (_0x7b3f.toUpperCase().includes(_t)) {
                const _0x2a4e = document.getElementById('manifestInput');
                const _0x7b3f2 = _0x2a4e.value.replace(new RegExp(_t, 'gi'), '') + 
                                '\n\n---\n' + _r + '\n---\n';
                _0x2a4e.value = _0x7b3f2;
                setTimeout(() => showSuccess('‚ú® +6Zero1Seven2Four777Three6!'), 100);
                return true;
            }
            return false;
        }
        
        // Helper Functions
        function truncateName(name) {
            if (!name || !name.includes('/')) return name || '';
            
            const parts = name.split('/');
            return parts.map(part => {
                const trimmed = part.trim();
                return trimmed.length > 15 ? trimmed.substring(0, 6) + '..' : trimmed;
            }).join('/');
        }
        
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(debounceTimer);
                    func(...args);
                };
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(later, wait);
            };
        }
        
        function showError(message) {
            const output = document.getElementById('reportContent');
            output.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function showSuccess(message) {
            const output = document.getElementById('reportContent');
            const existing = output.innerHTML;
            output.innerHTML = `<div class="success no-print">${message}</div>` + existing;
        }
        
        function hasValidManifest() {
            const input = document.getElementById('manifestInput').value;
            return input && input.trim().length > 0;
        }
        
        // Settings Management
        function updateSettingsFromControls() {
            currentSettings.aircraftType = document.getElementById('aircraftType').value;
            currentSettings.layoutStyle = document.getElementById('layoutStyle').value;
            currentSettings.fontSize = parseInt(document.getElementById('fontSizeSlider').value);
            currentSettings.tableWidth = parseInt(document.getElementById('tableWidthSlider').value);
            currentSettings.seatChartFontSize = parseInt(document.getElementById('seatChartFontSlider').value);
            currentSettings.compactPrint = document.getElementById('compactPrintMode').checked;
            currentSettings.landscapeMode = document.getElementById('landscapeMode').checked;
            currentSettings.pageBreakZones = document.getElementById('pageBreakBetweenZones').checked;
            currentSettings.avoidOrphans = document.getElementById('avoidOrphanRows').checked;
            currentSettings.flipSeatChart = document.getElementById('flipSeatChart').checked;
            currentSettings.showAllBusiness = document.getElementById('showAllBusiness').checked;
            currentSettings.showUnassignedInPrint = document.getElementById('showUnassignedInPrint').checked;
            
            updateUIFromSettings();
        }
        
        function updateUIFromSettings() {
            document.getElementById('fontSizeDisplay').textContent = currentSettings.fontSize + 'px';
            document.getElementById('tableWidthValue').textContent = currentSettings.tableWidth + '%';
            document.getElementById('seatChartFontValue').textContent = currentSettings.seatChartFontSize + 'px';
            
            // Apply visual settings
            const outputSection = document.querySelector('.output-section');
            if (outputSection) {
                outputSection.setAttribute('data-font-size', currentSettings.fontSize);
                outputSection.setAttribute('data-table-width', currentSettings.tableWidth);
            }
            
            // Apply print settings
            document.body.classList.toggle('compact-print-mode', currentSettings.compactPrint);
            document.body.classList.toggle('landscape-mode', currentSettings.landscapeMode);
            document.body.classList.toggle('avoid-orphan-rows', currentSettings.avoidOrphans);
        }
        
        function resetToDefaults() {
            currentSettings = {
                aircraftType: 'auto',
                layoutStyle: 'auto',
                fontSize: 9,
                tableWidth: 100,
                seatChartFontSize: 14,
                compactPrint: false,
                landscapeMode: false,
                pageBreakZones: true,
                avoidOrphans: true,
                flipSeatChart: false,
                showAllBusiness: false,
                showUnassignedInPrint: false,
                activeZones: {},
                detectedAircraftType: 'narrowbody'
            };
            
            // Update UI controls
            document.getElementById('aircraftType').value = 'auto';
            document.getElementById('layoutStyle').value = 'auto';
            document.getElementById('fontSizeSlider').value = 9;
            document.getElementById('tableWidthSlider').value = 100;
            document.getElementById('seatChartFontSlider').value = 14;
            document.getElementById('compactPrintMode').checked = false;
            document.getElementById('landscapeMode').checked = false;
            document.getElementById('pageBreakBetweenZones').checked = true;
            document.getElementById('avoidOrphanRows').checked = true;
            document.getElementById('flipSeatChart').checked = false;
            document.getElementById('showAllBusiness').checked = false;
            document.getElementById('showUnassignedInPrint').checked = false;
            
            updateUIFromSettings();
            
            if (hasValidManifest()) {
                generateReportWithCurrentSettings();
                showSuccess('‚úì Settings reset to defaults');
            }
        }
        
        // UI Controls
        function toggleHelp(type) {
            const tutorial = document.getElementById('tutorialContent');
            const version = document.getElementById('versionContent');
            const tutorialLabel = document.getElementById('tutorialLabel');
            const versionLabel = document.getElementById('versionLabel');
            
            if (type === 'tutorial') {
                const isChecked = document.getElementById('toggleTutorial').checked;
                tutorial.style.display = isChecked ? 'block' : 'none';
                tutorialLabel.textContent = isChecked ? 'Hide' : 'Show';
                
                if (isChecked) {
                    document.getElementById('toggleVersion').checked = false;
                    version.style.display = 'none';
                    versionLabel.textContent = 'Show';
                }
            } else {
                const isChecked = document.getElementById('toggleVersion').checked;
                version.style.display = isChecked ? 'block' : 'none';
                versionLabel.textContent = isChecked ? 'Hide' : 'Show';
                
                if (isChecked) {
                    document.getElementById('toggleTutorial').checked = false;
                    tutorial.style.display = 'none';
                    tutorialLabel.textContent = 'Show';
                }
            }
        }
        
        function toggleSettings() {
            const settings = document.getElementById('advancedSettings');
            const button = document.getElementById('toggleAdvanced');
            settings.classList.toggle('open');
            button.textContent = settings.classList.contains('open') ? '‚ñ≤ Advanced Settings' : '‚ñº Advanced Settings';
        }
        
        function onAircraftChange() {
            const aircraftType = document.getElementById('aircraftType').value;
            const customZonesDiv = document.getElementById('customZones');
            customZonesDiv.classList.toggle('open', aircraftType === 'custom');
            if (aircraftType === 'custom' && customZones.length === 0) {
                addCustomZone();
            }
            updateZoneCheckboxes();
            
            if (hasValidManifest()) {
                updateSettingsFromControls();
                generateReportWithCurrentSettings();
            }
        }
        
        function addCustomZone() {
            const zoneId = 'zone_' + Date.now();
            customZones.push({
                id: zoneId,
                name: 'Zone' + (customZones.length + 1),
                start: customZones.length > 0 ? customZones[customZones.length - 1].end + 1 : 1,
                end: customZones.length > 0 ? customZones[customZones.length - 1].end + 10 : 10
            });
            renderCustomZones();
            updateZoneCheckboxes();
        }
        
        function removeCustomZone(zoneId) {
            customZones = customZones.filter(zone => zone.id !== zoneId);
            renderCustomZones();
            updateZoneCheckboxes();
        }
        
        function updateCustomZone(zoneId, field, value) {
            const zone = customZones.find(z => z.id === zoneId);
            if (zone) {
                zone[field] = field === 'name' ? value : parseInt(value);
            }
        }
        
        function validateZoneNames() {
            const names = customZones.map(zone => zone.name.toUpperCase());
            const duplicates = names.filter((name, index) => names.indexOf(name) !== index);
            
            if (duplicates.length > 0) {
                document.getElementById('zoneError').textContent = 
                    `Error: Duplicate zone names found: ${duplicates.join(', ')}`;
                document.getElementById('zoneError').classList.add('show');
                return false;
            }
            document.getElementById('zoneError').classList.remove('show');
            return true;
        }
        
        function updateCustomZones() {
            if (!validateZoneNames()) return;
            updateZoneCheckboxes();
            
            if (hasValidManifest()) {
                updateSettingsFromControls();
                generateReportWithCurrentSettings();
            }
        }
        
        function renderCustomZones() {
            const zoneBuilder = document.getElementById('zoneBuilder');
            zoneBuilder.innerHTML = '';
            customZones.forEach(zone => {
                const zoneItem = document.createElement('div');
                zoneItem.className = 'zone-item';
                zoneItem.innerHTML = `
                    <input type="text" class="zone-name" value="${zone.name}" onchange="updateCustomZone('${zone.id}', 'name', this.value)" placeholder="Zone name">
                    <span>Rows:</span>
                    <input type="number" class="zone-start" value="${zone.start}" min="1" onchange="updateCustomZone('${zone.id}', 'start', parseInt(this.value))">
                    <span>to</span>
                    <input type="number" class="zone-end" value="${zone.end}" min="1" onchange="updateCustomZone('${zone.id}', 'end', parseInt(this.value))">
                    <button class="btn-primary btn-small" onclick="removeCustomZone('${zone.id}')">Remove</button>
                `;
                zoneBuilder.appendChild(zoneItem);
            });
        }
        
        function updateZoneCheckboxes() {
            const aircraftType = document.getElementById('aircraftType').value;
            const zoneCheckboxes = document.getElementById('zoneCheckboxes');
            let zones = aircraftType === 'custom' ? customZones : (AIRCRAFT_CONFIGS[aircraftType] || []);
            zoneCheckboxes.innerHTML = '';
            zones.forEach(zone => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'zone-checkbox';
                const isChecked = currentSettings.activeZones[zone.name] !== false;
                checkboxDiv.innerHTML = `
                    <label class="toggle-switch">
                        <input type="checkbox" id="showZone${zone.name}" ${isChecked ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                    <label class="toggle-label" for="showZone${zone.name}">${zone.name} (Rows ${zone.start}-${zone.end})</label>
                `;
                zoneCheckboxes.appendChild(checkboxDiv);
                
                const checkbox = checkboxDiv.querySelector('input');
                checkbox.addEventListener('change', () => {
                    currentSettings.activeZones[zone.name] = checkbox.checked;
                    if (hasValidManifest()) {
                        updateSettingsFromControls();
                        generateReportWithCurrentSettings();
                    }
                });
            });
        }
        
        function getCurrentZones() {
            const aircraftType = document.getElementById('aircraftType').value;
            let zones = aircraftType === 'custom' ? customZones : (AIRCRAFT_CONFIGS[aircraftType] || []);
            
            if (Object.keys(currentSettings.activeZones).length > 0) {
                zones = zones.filter(zone => currentSettings.activeZones[zone.name] !== false);
            }
            
            return zones;
        }
        
        function setFontSize(size) {
            document.getElementById('fontSizeSlider').value = size;
            updateSettingsFromControls();
            if (hasValidManifest()) {
                generateReportWithCurrentSettings();
            }
        }
        
        // NEW: Check if a zone is a business class zone
        function isBusinessClassZone(zoneName) {
            return zoneName === 'B' || zoneName === 'J' || zoneName.startsWith('B') || zoneName.startsWith('J');
        }
        
        // NEW: Get effective layout with widebody defaulting to port-starboard
        function getEffectiveLayout(detectedType) {
            if (currentSettings.layoutStyle === 'auto') {
                // Default to port-starboard for all widebody aircraft
                return detectedType === 'widebody' ? 'port-starboard' : 'single';
            }
            return currentSettings.layoutStyle;
        }
        
        // Manifest Parsing and Report Generation
        function parseManifest(text) {
            // EASTER EGG: Check for special input first
            if (_0x2a4e(text)) {
                return { flightInfo: {}, passengers: [] };
            }
            
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
            const passengers = [];
            let flightInfo = { flightNumber: '', sector: '', aircraft: '', date: '', stdLocal: '' };
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i] === 'FLT NBR' && i + 1 < lines.length) flightInfo.flightNumber = lines[i + 1];
                if (lines[i] === 'Sector' && i + 1 < lines.length) flightInfo.sector = lines[i + 1];
                if (lines[i] === 'ACFT' && i + 1 < lines.length) flightInfo.aircraft = lines[i + 1];
                if (lines[i] === 'STD LT' && i + 1 < lines.length) {
                    const parts = lines[i + 1].split(/\s+/);
                    if (parts.length >= 2) {
                        flightInfo.date = parts[0];
                        flightInfo.stdLocal = parts[1];
                    }
                }
            }
            
            let startIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i] === 'MEALS' || lines[i].includes('Passenger & Meal Count')) {
                    startIndex = i + 1;
                    break;
                }
            }
            
            if (startIndex === -1) return { flightInfo, passengers };
            
            let i = startIndex;
            while (i < lines.length) {
                const line = lines[i];
                if (line.includes('-- END of PAX List') || (line.includes('Showing') && line.includes('entries'))) break;
                if (line === '-- CUT HERE --') { i++; continue; }
                
                const passenger = { title: '', name: '', seat: '', pnr: '', class: '', fqtv: '', tier: '', meal: '', remark: '' };
                
                if (CONFIG.TITLES.includes(line)) {
                    passenger.title = line;
                    i++;
                    if (i >= lines.length) break;
                }
                
                if (i < lines.length && lines[i].includes('/')) {
                    passenger.name = truncateName(lines[i]);
                    i++;
                } else {
                    i++;
                    continue;
                }
                
                while (i < lines.length) {
                    const field = lines[i];
                    if (CONFIG.TITLES.includes(field) || field.includes('/') || field === '-- CUT HERE --' || field.includes('-- END of PAX List')) break;
                    
                    if (!passenger.seat && CONFIG.SEAT_PATTERN.test(field)) passenger.seat = field.toUpperCase();
                    else if (!passenger.pnr && CONFIG.PNR_PATTERN.test(field)) passenger.pnr = field.toUpperCase();
                    else if (!passenger.class && CONFIG.CLASS_PATTERN.test(field)) passenger.class = field.toUpperCase();
                    else if (!passenger.tier && CONFIG.TIERS.includes(field.toUpperCase())) passenger.tier = field.toUpperCase();
                    else if (!passenger.meal && field.toUpperCase().includes('ML')) {
                        const upperField = field.toUpperCase();
                        if (upperField.includes(',')) {
                            const validMeals = upperField.split(',').map(m => m.trim()).filter(m => /^[A-Z]{4}$/i.test(m) && m.endsWith('ML'));
                            if (validMeals.length > 0) passenger.meal = validMeals.join(',');
                        } else {
                            if (/^[A-Z]{4}$/i.test(upperField) && upperField.endsWith('ML')) passenger.meal = upperField;
                        }
                    }
                    else if (field.toUpperCase().includes('UPGRADED')) {
                        passenger.remark = 'UPG';
                    }
                    else if (field.toUpperCase().includes('DOWNGRADED')) {
                        passenger.remark = 'DNG';
                    }
                    i++;
                }
                
                if (passenger.name && passenger.class) passengers.push(passenger);
            }
            
            return { flightInfo, passengers };
        }
        
        function generateQuickReport() {
            const input = document.getElementById('manifestInput').value;
            if (!input.trim()) {
                showError('Please paste passenger manifest data.');
                return;
            }
            
            try {
                const { flightInfo, passengers } = parseManifest(input);
                currentSettings.detectedAircraftType = detectAircraftType(passengers, flightInfo);
                
                document.getElementById('aircraftType').value = 'auto';
                document.getElementById('layoutStyle').value = 'auto';
                
                updateSettingsFromControls();
                generateReportWithCurrentSettings();
            } catch (error) {
                showError(`Error: ${error.message}`);
            }
        }
        
        function generateReportWithCurrentSettings() {
            const input = document.getElementById('manifestInput').value;
            if (!input.trim()) return;
            
            try {
                const { flightInfo, passengers } = parseManifest(input);
                const filtered = passengers.filter(p => p.meal || p.tier === 'EMER' || p.tier === 'PLAT');
                
                if (filtered.length === 0 && !currentSettings.showAllBusiness) {
                    showError('No passengers found with special meals or EMER/PLAT tier.');
                    return;
                }
                
                currentSettings.detectedAircraftType = detectAircraftType(passengers, flightInfo);
                const effectiveLayout = getEffectiveLayout(currentSettings.detectedAircraftType);
                const effectiveAircraftConfig = getEffectiveAircraftConfig(currentSettings.detectedAircraftType, flightInfo, passengers);
                
                const flightInfoHTML = `<div class="flight-info">Flight: ${flightInfo.flightNumber} | Route: ${flightInfo.sector} | Date: ${flightInfo.date} ${flightInfo.stdLocal} | ACFT: ${flightInfo.aircraft}</div>`;
                const globalSummaryHTML = generateGlobalSummary(filtered);
                
                let seatChartControls = '';
                if (effectiveLayout === 'seat-chart') {
                    seatChartControls = `
                        <div class="seat-chart-controls">
                            <label>Seat Chart Font Size: 
                                <input type="range" id="seatChartFontSliderInline" min="8" max="16" value="${currentSettings.seatChartFontSize}" step="1" oninput="document.getElementById('seatChartFontSlider').value = this.value; updateSettingsFromControls(); generateReportWithCurrentSettings();" style="width: 120px;">
                                <span>${currentSettings.seatChartFontSize}px</span>
                            </label>
                            ${currentSettings.flipSeatChart ? '<div class="magic-option"><span>üîÑ Aft Perspective Active - Print and turn paper 180¬∞</span></div>' : ''}
                            ${currentSettings.showAllBusiness ? '<div class="magic-option"><span>üëî Business Class Display Active - Showing all business class passengers</span></div>' : ''}
                            ${currentSettings.showUnassignedInPrint ? '<div class="magic-option"><span>üìã Unassigned Table WILL BE INCLUDED in Print</span></div>' : ''}
                        </div>
                    `;
                }
                
                const zones = getCurrentZones();
                let tableContent = '';
                
                if (zones.length > 0) {
                    const zonePassengers = {};
                    const unassigned = [];
                    
                    zones.forEach(zone => { zonePassengers[zone.name] = []; });
                    
                    // FIXED: Only use all passengers for business class zones when showAllBusiness is enabled
                    const passengersToProcess = currentSettings.showAllBusiness ? passengers : filtered;
                    
                    passengersToProcess.forEach(p => {
                        let assigned = false;
                        if (p.seat) {
                            const rowNum = parseInt(p.seat.substring(0, 2));
                            for (const zone of zones) {
                                if (rowNum >= zone.start && rowNum <= zone.end) {
                                    // FIXED: For business class zones with showAllBusiness, include all passengers
                                    // For economy zones or when showAllBusiness is false, only include filtered passengers
                                    if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name)) {
                                        zonePassengers[zone.name].push(p);
                                        assigned = true;
                                        break;
                                    } else if (!currentSettings.showAllBusiness || !isBusinessClassZone(zone.name)) {
                                        // Only add if passenger has special requirements
                                        if (p.meal || p.tier === 'EMER' || p.tier === 'PLAT') {
                                            zonePassengers[zone.name].push(p);
                                            assigned = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                        if (!assigned) unassigned.push(p);
                    });
                    
                    Object.keys(zonePassengers).forEach(zoneName => {
                        zonePassengers[zoneName].sort((a, b) => {
                            if (!a.seat) return 1;
                            if (!b.seat) return -1;
                            return parseInt(a.seat) - parseInt(b.seat);
                        });
                    });
                    
                    let zoneIndex = 0;
                    for (const zone of zones) {
                        const zonePax = zonePassengers[zone.name] || [];
                        if (zonePax.length === 0) continue;
                        
                        const pageBreakClass = currentSettings.pageBreakZones && zoneIndex > 0 ? 'page-break' : '';
                        tableContent += `<div class="zone-section ${pageBreakClass}">`;
                        tableContent += `<div class="zone-header">${flightInfo.flightNumber} - ${zone.name} - Rows ${zone.start}-${zone.end}</div>`;
                        tableContent += generateZoneStats(zonePax);
                        
                        if (effectiveLayout === 'seat-chart') {
                            // FIXED: Use the correct passenger list for each zone type
                            let seatChartPassengers = zonePax;
                            tableContent += generateSeatChart(seatChartPassengers, zone, effectiveAircraftConfig);
                        } else if (effectiveLayout === 'port-starboard') {
                            if (currentSettings.detectedAircraftType === 'widebody') {
                                const portPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['A', 'B', 'C', 'D', 'E'].includes(seatLetter);
                                });
                                const starboardPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['F', 'G', 'H', 'J', 'K'].includes(seatLetter);
                                });
                                
                                tableContent += `<div class="tables-container">`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">PORT SIDE (ABCDE)</div>`;
                                tableContent += generateSideStats(portPax, 'Port');
                                tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">STARBOARD SIDE (FGHJK)</div>`;
                                tableContent += generateSideStats(starboardPax, 'Starboard');
                                tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `</div>`;
                            } else {
                                const portPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['A', 'B', 'C'].includes(seatLetter);
                                });
                                const starboardPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['D', 'E', 'F'].includes(seatLetter);
                                });
                                
                                tableContent += `<div class="tables-container">`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">PORT SIDE (ABC)</div>`;
                                tableContent += generateSideStats(portPax, 'Port');
                                tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">STARBOARD SIDE (DEF)</div>`;
                                tableContent += generateSideStats(starboardPax, 'Starboard');
                                tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `</div>`;
                            }
                        } else {
                            tableContent += generateTable(zonePax, true, currentSettings.detectedAircraftType);
                        }
                        
                        tableContent += `</div>`;
                        zoneIndex++;
                    }
                    
                    if (unassigned.length > 0) {
                        // NEW: Use the showUnassignedInPrint setting to determine which class to use
                        const unassignedClass = currentSettings.showUnassignedInPrint ? 'unassigned-print' : 'unassigned-no-print';
                        const pageBreakClass = currentSettings.pageBreakZones && zoneIndex > 0 ? 'page-break' : '';
                        tableContent += `<div class="zone-section ${unassignedClass} ${pageBreakClass}">`;
                        tableContent += `<div class="zone-header">UNASSIGNED SEATS</div>`;
                        tableContent += generateUnassignedTable(unassigned, currentSettings.detectedAircraftType);
                        tableContent += `</div>`;
                    }
                } else {
                    filtered.sort((a, b) => {
                        if (a.class !== b.class) return a.class === 'J' ? -1 : 1;
                        if (!a.seat) return 1;
                        if (!b.seat) return -1;
                        return parseInt(a.seat) - parseInt(b.seat);
                    });
                    
                    if (effectiveLayout === 'seat-chart') {
                        const allZones = AIRCRAFT_CONFIGS[effectiveAircraftConfig] || [];
                        if (allZones.length > 0) {
                            allZones.forEach(zone => {
                                tableContent += `<div class="zone-section">`;
                                tableContent += `<div class="zone-header">${flightInfo.flightNumber} - ${zone.name} - Rows ${zone.start}-${zone.end}</div>`;
                                tableContent += generateSeatChart(filtered, zone, effectiveAircraftConfig);
                                tableContent += `</div>`;
                            });
                        }
                    } else if (effectiveLayout === 'port-starboard') {
                        if (currentSettings.detectedAircraftType === 'widebody') {
                            const portPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['A', 'B', 'C', 'D', 'E'].includes(seatLetter);
                            });
                            const starboardPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['F', 'G', 'H', 'J', 'K'].includes(seatLetter);
                            });
                            const unassigned = filtered.filter(p => !p.seat);
                            
                            tableContent += `<div class="tables-container">`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">PORT SIDE (ABCDE)</div>`;
                            tableContent += generateSideStats(portPax, 'Port');
                            tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">STARBOARD SIDE (FGHJK)</div>`;
                            tableContent += generateSideStats(starboardPax, 'Starboard');
                            tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            tableContent += `</div>`;
                            
                            if (unassigned.length > 0) {
                                // NEW: Use the showUnassignedInPrint setting to determine which class to use
                                const unassignedClass = currentSettings.showUnassignedInPrint ? 'unassigned-print' : 'unassigned-no-print';
                                tableContent += `<div class="zone-section ${unassignedClass}">`;
                                tableContent += `<div class="zone-header">UNASSIGNED SEATS</div>`;
                                tableContent += generateUnassignedTable(unassigned, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                            }
                        } else {
                            const portPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['A', 'B', 'C'].includes(seatLetter);
                            });
                            const starboardPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['D', 'E', 'F'].includes(seatLetter);
                            });
                            const unassigned = filtered.filter(p => !p.seat);
                            
                            tableContent += `<div class="tables-container">`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">PORT SIDE (ABC)</div>`;
                            tableContent += generateSideStats(portPax, 'Port');
                            tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">STARBOARD SIDE (DEF)</div>`;
                            tableContent += generateSideStats(starboardPax, 'Starboard');
                            tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            tableContent += `</div>`;
                            
                            if (unassigned.length > 0) {
                                // NEW: Use the showUnassignedInPrint setting to determine which class to use
                                const unassignedClass = currentSettings.showUnassignedInPrint ? 'unassigned-print' : 'unassigned-no-print';
                                tableContent += `<div class="zone-section ${unassignedClass}">`;
                                tableContent += `<div class="zone-header">UNASSIGNED SEATS</div>`;
                                tableContent += generateUnassignedTable(unassigned, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                            }
                        }
                    } else {
                        tableContent += generateTable(filtered, true, currentSettings.detectedAircraftType);
                    }
                }
                
                const html = flightInfoHTML + globalSummaryHTML + seatChartControls + tableContent;
                let successMessage = '‚úì Report generated successfully! ';
                
                if (currentSettings.showAllBusiness) {
                    const businessZones = zones.filter(zone => isBusinessClassZone(zone.name));
                    if (businessZones.length > 0) {
                        successMessage += `Showing ALL passengers in ${businessZones.length} business class zone${businessZones.length > 1 ? 's' : ''}. `;
                    }
                    successMessage += `${filtered.length} passengers with special requirements found.`;
                } else {
                    successMessage += `${filtered.length} passengers with special requirements found.`;
                }
                
                // NEW: Apply seat chart flipping if enabled
                document.getElementById('reportContent').innerHTML = `<div class="success no-print">${successMessage}</div>` + html;
                
                if (currentSettings.flipSeatChart) {
                    const flipped = flipAllSeatCharts();
                    if (flipped) {
                        showSuccess('‚úì Report generated successfully! Seat charts flipped for aft perspective - print and turn paper 180¬∞.');
                    }
                }
                
                updateUIFromSettings();
                
                const pages = Math.ceil(filtered.length / (currentSettings.fontSize <= 9 ? 50 : currentSettings.fontSize >= 12 ? 35 : 40));
                document.getElementById('pageEstimate').textContent = `~${pages} page${pages !== 1 ? 's' : ''}`;
                
            } catch (error) {
                showError(`Error: ${error.message}<br><br>Please make sure you copied the complete passenger list from BPM.`);
                console.error(error);
            }
        }
        
        function generateGlobalSummary(filtered) {
            const specialMealCount = filtered.filter(p => p.meal).length;
            const tierCount = filtered.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
            let bbmlCount = 0;
            const mealCounts = {};
            filtered.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal === 'BBML') bbmlCount++;
                        else if (meal) mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                    });
                }
            });
            const mealBreakdown = Object.entries(mealCounts).sort((a, b) => b[1] - a[1]).map(([meal, count]) => `${meal}: ${count}`).join(', ');
            let html = `<div class="stats"><strong>Summary:</strong> Special Meals: ${specialMealCount} | EMER/PLAT: ${tierCount}`;
            if (bbmlCount > 0) html += ` | Infants (BBML): ${bbmlCount}`;
            html += `<br><strong>Meal Breakdown:</strong> ${mealBreakdown || 'None'}`;
            if (bbmlCount > 0) html += ` | BBML: ${bbmlCount}`;
            html += `</div>`;
            return html;
        }
        
        function generateZoneStats(passengers) {
            const specialMealCount = passengers.filter(p => p.meal).length;
            const tierCount = passengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
            let bbmlCount = 0;
            const mealCounts = {};
            passengers.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal === 'BBML') bbmlCount++;
                        else if (meal) mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                    });
                }
            });
            const mealBreakdown = Object.entries(mealCounts).sort((a, b) => b[1] - a[1]).map(([meal, count]) => `${meal}: ${count}`).join(', ');
            let html = `<div class="stats"><strong>Zone Summary:</strong> Special Meals: ${specialMealCount} | EMER/PLAT: ${tierCount}`;
            if (bbmlCount > 0) html += ` | Infants (BBML): ${bbmlCount}`;
            html += `<br><strong>Zone Meal Breakdown:</strong> ${mealBreakdown || 'None'}`;
            if (bbmlCount > 0) html += ` | BBML: ${bbmlCount}`;
            html += `</div>`;
            return html;
        }
        
        function generateSideStats(passengers, sideName) {
            const specialMealCount = passengers.filter(p => p.meal).length;
            const tierCount = passengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
            let bbmlCount = 0;
            const mealCounts = {};
            passengers.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal === 'BBML') bbmlCount++;
                        else if (meal) mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                    });
                }
            });
            const mealBreakdown = Object.entries(mealCounts).sort((a, b) => b[1] - a[1]).map(([meal, count]) => `${meal}: ${count}`).join(', ');
            let html = `<div class="side-stats"><strong>${sideName}:</strong> Meals: ${specialMealCount} | EMER/PLAT: ${tierCount}`;
            if (bbmlCount > 0) html += ` | BBML: ${bbmlCount}`;
            if (mealBreakdown) html += `<br>${mealBreakdown}`;
            html += `</div>`;
            return html;
        }
        
        function generateTable(passengers, showSeat = false, aircraftType = 'narrowbody') {
            if (passengers.length === 0) {
                const headers = showSeat ? '<th>SEAT</th><th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>' : '<th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>';
                return `<table><thead><tr>${headers}</tr></thead><tbody><tr><td colspan="${showSeat ? 5 : 4}" style="text-align:center;">No passengers</td></tr></tbody></table>`;
            }
            
            const tableClass = aircraftType === 'widebody' ? 'widebody-table' : 'narrowbody-table';
            let html = `<table class="${tableClass}">`;
            
            const headers = showSeat ? 
                `<th>SEAT</th><th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>` : 
                `<th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>`;
                
            html += `<thead><tr>${headers}</tr></thead><tbody>`;
            
            passengers.forEach(p => {
                const meals = p.meal ? p.meal.split(',').map(m => m.trim()) : [];
                const parentMeal = meals.find(m => m !== 'BBML') || '';
                const infantMeal = meals.find(m => m === 'BBML') || '';
                let mealDisplay = '';
                if (parentMeal && infantMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong><span class="infant-meal">(+${infantMeal})</span>`;
                } else if (parentMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong>`;
                } else if (infantMeal) {
                    mealDisplay = `<strong>${infantMeal}</strong>`;
                }
                
                let remarkIndicator = '';
                if (p.remark === 'UPG') {
                    remarkIndicator = '<span class="upgrade-indicator">‚Üë</span>';
                } else if (p.remark === 'DNG') {
                    remarkIndicator = '<span class="downgrade-indicator">‚Üì</span>';
                }
                
                html += `<tr>`;
                if (showSeat) {
                    if (p.seat) {
                        html += `<td><strong>${p.seat}</strong>${remarkIndicator}</td>`;
                    } else {
                        html += `<td style="border: 1px dashed #999; background: #fffacd;">&nbsp;</td>`;
                    }
                }
                html += `<td>${p.title}</td><td>${p.name}</td><td><strong>${p.tier}</strong></td><td>${mealDisplay}</td></tr>`;
            });
            
            html += `</tbody></table>`;
            return html;
        }
        
        function generateUnassignedTable(passengers, aircraftType) {
            if (passengers.length === 0) {
                return '';
            }
            
            const tableClass = aircraftType === 'widebody' ? 'widebody-table' : 'narrowbody-table';
            let html = `<table class="${tableClass}">`;
            html += `<thead><tr><th>SEAT</th><th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th></tr></thead><tbody>`;
            
            passengers.forEach(p => {
                const meals = p.meal ? p.meal.split(',').map(m => m.trim()) : [];
                const parentMeal = meals.find(m => m !== 'BBML') || '';
                const infantMeal = meals.find(m => m === 'BBML') || '';
                let mealDisplay = '';
                if (parentMeal && infantMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong><span class="infant-meal">(+${infantMeal})</span>`;
                } else if (parentMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong>`;
                } else if (infantMeal) {
                    mealDisplay = `<strong>${infantMeal}</strong>`;
                }
                
                html += `<tr>`;
                html += `<td style="border: 1px dashed #999; background: #fffacd;">&nbsp;</td>`;
                html += `<td>${p.title}</td><td>${p.name}</td><td><strong>${p.tier}</strong></td><td>${mealDisplay}</td>`;
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            return html;
        }
        
        function getTierClass(tier) {
            if (tier === 'EMER') return 'seat-tier-emer';
            if (tier === 'PLAT') return 'seat-tier-plat';
            
            return '';
        }
        
        // NEW: Check if passenger has special requirements
        function hasSpecialRequirements(passenger) {
            return passenger.meal || passenger.tier === 'EMER' || passenger.tier === 'PLAT';
        }
        
        // Helper function to format meal display with BBML
        function formatMealDisplay(mealString) {
            if (!mealString) return '';
            
            const meals = mealString.split(',').map(m => m.trim());
            const parentMeal = meals.find(m => m !== 'BBML') || '';
            const infantMeal = meals.find(m => m === 'BBML') || '';
            
            let mealDisplay = '';
            if (parentMeal && infantMeal) {
                mealDisplay = `${parentMeal}:BBML`;
            } else if (parentMeal) {
                mealDisplay = parentMeal;
            } else if (infantMeal) {
                mealDisplay = infantMeal;
            }
            
            return mealDisplay;
        }
        
        // UPDATED: Generate seat chart with optimized multi-line format for business class and 737 business class layout
        // NOW WITH ALWAYS-SHOW MEAL LINE IN BUSINESS CLASS
        function generateSeatChart(passengers, zone, aircraftConfig) {
            const seatMap = SEAT_MAPS[aircraftConfig];
            if (!seatMap) {
                return `<div class="error">Seat chart not available for selected aircraft configuration.</div>`;
            }
            
            // Determine if this is a business class zone and narrowbody aircraft
            const isBusinessZone = isBusinessClassZone(zone.name);
            const isNarrowbody = ['737NG', '737MAX', '737NR'].includes(aircraftConfig);
            
            // Choose the appropriate columns based on aircraft type and zone
            let columns, aisles;
            if (isNarrowbody && isBusinessZone && seatMap.businessColumns) {
                // Use business class columns for 737 business class (no B and E seats)
                columns = seatMap.businessColumns;
                aisles = [2]; // Aisle after C in business class layout
            } else {
                // Use standard columns for all other cases
                columns = seatMap.columns;
                aisles = seatMap.aisles;
            }
            
            const startRow = zone.start;
            const endRow = zone.end;
            
            // Choose the appropriate CSS class for column widths
            let tableClass = 'seat-chart';
            if (isNarrowbody) {
                tableClass += isBusinessZone ? ' narrowbody-business' : ' narrowbody-economy';
            } else {
                tableClass += ' widebody';
            }
            
            let html = `<div class="seat-chart-container">
                <table class="${tableClass}" data-font-size="${currentSettings.seatChartFontSize}">
                <thead><tr><th class="row-header">Row</th>`;
            
            // Create header row with seat letters
            columns.forEach(col => {
                if (col === '|') {
                    html += `<th class="aisle"></th>`;
                } else {
                    html += `<th>${col}</th>`;
                }
            });
            
            html += `</tr></thead><tbody>`;
            
            // Create rows for each seat row in the zone
            for (let row = startRow; row <= endRow; row++) {
                // Skip row 3 for A330-300 business class
                if (aircraftConfig === '333' && row === 3 && zone.name === 'B') {
                    continue;
                }
                
                const rowNum = row.toString().padStart(2, '0');
                const isZoneBoundary = row === zone.end;
                
                // Add alternating row classes for better readability
                const rowClass = (row % 2 === 0) ? 'row-even' : 'row-odd';
                const additionalClasses = isZoneBoundary ? `zone-boundary ${rowClass}` : rowClass;
                
                html += `<tr class="${additionalClasses}"><td class="row-header">${rowNum}</td>`;
                
                // Check if this is an A330-300 business class row that needs merging
                const isA333BusinessRow = aircraftConfig === '333' && 
                                         seatMap.businessClassRows && 
                                         seatMap.businessClassRows.includes(row) &&
                                         zone.name === 'B';
                
                const isExceptionRow = isA333BusinessRow && [2, 5, 7].includes(row);
                
                if (isA333BusinessRow && seatMap.businessClassMerges && !isExceptionRow) {
                    // A330-300 Business Class with merged seats
                    let colIndex = 0;
                    while (colIndex < columns.length) {
                        const col = columns[colIndex];
                        
                        if (col === '|') {
                            html += `<td class="aisle"></td>`;
                            colIndex++;
                            continue;
                        }
                        
                        // Check if this column is part of a merge
                        let merged = false;
                        for (const [mergedSeat, mergeData] of Object.entries(seatMap.businessClassMerges)) {
                            const [seatsToMerge, options] = Array.isArray(mergeData[0]) ? 
                                [mergeData[0], mergeData[1]] : [mergeData, null];
                            
                            // Check if current column is in the merge list
                            if (seatsToMerge.includes(col)) {
                                // Check for exceptions
                                if (options && options.exceptions && options.exceptions.includes(row)) {
                                    // This is an exception row, don't merge
                                    break;
                                }
                                
                                // Create merged cell
                                const colspan = seatsToMerge.length;
                                const displaySeat = mergedSeat;
                                const seatNumber = `${rowNum}${displaySeat}`;
                                
                                // Find passenger in any of the merged seats
                                let passenger = null;
                                for (const seat of seatsToMerge) {
                                    const testSeat = `${rowNum}${seat}`;
                                    passenger = passengers.find(p => p.seat === testSeat);
                                    if (passenger) break;
                                }
                                
                                // Determine cell class based on passenger type
                                let cellClass = 'seat-empty';
                                let tierClass = '';
                                
                                if (passenger) {
                                    cellClass = 'seat-occupied';
                                    tierClass = getTierClass(passenger.tier);
                                    
                                    // For business class display, check if this is a regular business passenger
                                    if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name) && !hasSpecialRequirements(passenger)) {
                                        cellClass = 'seat-business-regular';
                                    }
                                }
                                
                                html += `<td class="${cellClass} ${tierClass}" colspan="${colspan}">`;
                                if (passenger) {
                                    // UPDATED: Different format for business class vs economy
                                    const mealDisplay = formatMealDisplay(passenger.meal);
                                    const tierIcon = passenger.tier === 'PLAT' ? '‚ù§Ô∏è ' : (passenger.tier === 'EMER' ? 'üî¥ ' : '');
                                    
                                    if (isBusinessZone) {
                                        // BUSINESS CLASS: Multi-line format with ALWAYS-SHOW meal line
                                        const businessName = truncateNameForBusinessClass(passenger.name);
                                        const nameParts = businessName.split('/');
                                        const firstName = nameParts[0] || '';
                                        const lastName = nameParts[1] || '';
                                        
                                        html += `<div class="seat-cell business-class">
                                            <div class="seat-line1">${tierIcon + passenger.title + '/' + firstName.toUpperCase()}</div>
                                            ${lastName ? `<div class="seat-line2">${lastName.toUpperCase()}</div>` : ''}
                                            <div class="seat-line3">${mealDisplay ? mealDisplay.toUpperCase() : '&nbsp;'}</div>
                                        </div>`;
                                    } else {
                                        // ECONOMY: Standard 2-line format - only show meal if exists
                                        const namePart = passenger.title + '/' + passenger.name.split('/')[0];
                                        
                                        html += `<div class="seat-cell">
                                            <div class="seat-line1">${tierIcon + namePart.toUpperCase()}</div>
                                            ${mealDisplay ? `<div class="seat-line2">${mealDisplay.toUpperCase()}</div>` : ''}
                                        </div>`;
                                    }
                                } else {
                                    html += `<div class="seat-cell">${seatNumber}</div>`;
                                }
                                html += `</td>`;
                                
                                colIndex += colspan;
                                merged = true;
                                break;
                            }
                        }
                        
                        if (!merged) {
                            // Normal cell
                            const seatNumber = `${rowNum}${col}`;
                            const passenger = passengers.find(p => p.seat === seatNumber);
                            
                            // Determine cell class based on passenger type
                            let cellClass = 'seat-empty';
                            let tierClass = '';
                            
                            if (passenger) {
                                cellClass = 'seat-occupied';
                                tierClass = getTierClass(passenger.tier);
                                
                                // For business class display, check if this is a regular business passenger
                                if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name) && !hasSpecialRequirements(passenger)) {
                                    cellClass = 'seat-business-regular';
                                }
                            }
                            
                            html += `<td class="${cellClass} ${tierClass}">`;
                            if (passenger) {
                                // UPDATED: Different format for business class vs economy
                                const mealDisplay = formatMealDisplay(passenger.meal);
                                const tierIcon = passenger.tier === 'PLAT' ? '‚ù§Ô∏è ' : (passenger.tier === 'EMER' ? 'üî¥ ' : '');
                                
                                if (isBusinessZone) {
                                    // BUSINESS CLASS: Multi-line format with ALWAYS-SHOW meal line
                                    const businessName = truncateNameForBusinessClass(passenger.name);
                                    const nameParts = businessName.split('/');
                                    const firstName = nameParts[0] || '';
                                    const lastName = nameParts[1] || '';
                                    
                                    html += `<div class="seat-cell business-class">
                                        <div class="seat-line1">${tierIcon + passenger.title + '/' + firstName.toUpperCase()}</div>
                                        ${lastName ? `<div class="seat-line2">${lastName.toUpperCase()}</div>` : ''}
                                        <div class="seat-line3">${mealDisplay ? mealDisplay.toUpperCase() : '&nbsp;'}</div>
                                    </div>`;
                                } else {
                                    // ECONOMY: Standard 2-line format - only show meal if exists
                                    const namePart = passenger.title + '/' + passenger.name.split('/')[0];
                                    
                                    html += `<div class="seat-cell">
                                        <div class="seat-line1">${tierIcon + namePart.toUpperCase()}</div>
                                        ${mealDisplay ? `<div class="seat-line2">${mealDisplay.toUpperCase()}</div>` : ''}
                                    </div>`;
                                }
                            } else {
                                html += `<div class="seat-cell">${seatNumber}</div>`;
                            }
                            html += `</td>`;
                            colIndex++;
                        }
                    }
                } else {
                    // Normal row generation
                    columns.forEach(col => {
                        if (col === '|') {
                            html += `<td class="aisle"></td>`;
                        } else {
                            const seatNumber = `${rowNum}${col}`;
                            const passenger = passengers.find(p => p.seat === seatNumber);
                            
                            // Determine cell class based on passenger type
                            let cellClass = 'seat-empty';
                            let tierClass = '';
                            
                            if (passenger) {
                                cellClass = 'seat-occupied';
                                tierClass = getTierClass(passenger.tier);
                                
                                // For business class display, check if this is a regular business passenger
                                if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name) && !hasSpecialRequirements(passenger)) {
                                    cellClass = 'seat-business-regular';
                                }
                            }
                            
                            html += `<td class="${cellClass} ${tierClass}">`;
                            if (passenger) {
                                // UPDATED: Different format for business class vs economy
                                const mealDisplay = formatMealDisplay(passenger.meal);
                                const tierIcon = passenger.tier === 'PLAT' ? '‚ù§Ô∏è ' : (passenger.tier === 'EMER' ? 'üî¥ ' : '');
                                
                                if (isBusinessZone) {
                                    // BUSINESS CLASS: Multi-line format with ALWAYS-SHOW meal line
                                    const businessName = truncateNameForBusinessClass(passenger.name);
                                    const nameParts = businessName.split('/');
                                    const firstName = nameParts[0] || '';
                                    const lastName = nameParts[1] || '';
                                    
                                    html += `<div class="seat-cell business-class">
                                        <div class="seat-line1">${tierIcon + passenger.title + '/' + firstName.toUpperCase()}</div>
                                        ${lastName ? `<div class="seat-line2">${lastName.toUpperCase()}</div>` : ''}
                                        <div class="seat-line3">${mealDisplay ? mealDisplay.toUpperCase() : '&nbsp;'}</div>
                                    </div>`;
                                } else {
                                    // ECONOMY: Standard 2-line format - only show meal if exists
                                    const namePart = passenger.title + '/' + passenger.name.split('/')[0];
                                    
                                    html += `<div class="seat-cell">
                                        <div class="seat-line1">${tierIcon + namePart.toUpperCase()}</div>
                                        ${mealDisplay ? `<div class="seat-line2">${mealDisplay.toUpperCase()}</div>` : ''}
                                    </div>`;
                                }
                            } else {
                                html += `<div class="seat-cell">${seatNumber}</div>`;
                            }
                            html += `</td>`;
                        }
                    });
                }
                
                html += `</tr>`;
            }
            
            html += `</tbody></table></div>`;
            return html;
        }
        
        function clearAll() {
            document.getElementById('manifestInput').value = '';
            document.getElementById('reportContent').innerHTML = '';
        }
        
        function downloadPage() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bpm-pro.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSuccess('‚úì Offline version downloaded as bpm-pro.html');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateZoneCheckboxes();
            updateUIFromSettings();
            
            // Set up live preview for all controls
            const controls = [
                'aircraftType', 'layoutStyle', 'fontSizeSlider', 'tableWidthSlider',
                'seatChartFontSlider', 'compactPrintMode', 'landscapeMode', 
                'pageBreakBetweenZones', 'avoidOrphanRows', 'flipSeatChart', 'showAllBusiness',
                'showUnassignedInPrint'
            ];
            
            controls.forEach(controlId => {
                const control = document.getElementById(controlId);
                if (control) {
                    control.addEventListener('change', debounce(() => {
                        updateSettingsFromControls();
                        if (hasValidManifest()) {
                            generateReportWithCurrentSettings();
                        }
                    }, 300));
                }
            });
            
            // Keyboard shortcut
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const textarea = document.getElementById('manifestInput');
                    if (textarea.value.trim()) {
                        e.preventDefault();
                        generateQuickReport();
                    }
                }
            });
        });
    </script>
</body>
</html>